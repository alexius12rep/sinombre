<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador Acad√©mico Inteligente</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <!-- Font Audiowide SOLO para el logo -->
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet">
    <!-- Font Awesome para √≠conos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #050916;
            --color-secondary: #0b5657;
            --color-accent: #0d3430;
            --color-light: #ffffff;
            --color-dark: #0080ff;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #032711;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
            --header-height: 50px;
            --settings-btn-size: 50px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            min-height: 100vh;
            color: var(--color-text);
            overflow-x: hidden;
            position: relative;
            transition: 0.3s, color 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Ajuste para cuando el usuario est√° logueado */
        body.logged-in .app-container {
            padding-top: 0; /* Elimina el padding superior cuando el usuario est√° logueado */
        }

        body.logged-in .top-header {
            display: none; /* Oculta la cabecera cuando el usuario est√° logueado */
        }

        /* Logo principal - SOLO aqu√≠ aplicamos Audiowide */
        .login-title, .logo-title {
            font-family: 'Audiowide', cursive !important;
            font-size: 1.8rem;
            color: var(--color-text);
            text-align: center;
        }

        /* Eliminamos Audiowide de TODOS los botones y dem√°s elementos */
        .add-materia-btn,
        .btn,
        .settings-menu,
        .settings-item,
        .modal-title,
        .section-title,
        .app-title,
        .sidebar-title,
        .auth-btn,
        .login-btn,
        .tarea-btn,
        .custom-dialog-btn,
        .skip-btn,
        .fixed-buttons-container button,
        .add-group-btn { /* Added .add-group-btn here */
            font-weight: 600; 
            letter-spacing: 0.5px; 
        }

        .background-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('logosinfondo.png');
            background-size: 30%;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.1;
            z-index: -1;
            pointer-events: none;
            background-attachment: fixed;
        }

        /* Header superior */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            border-bottom: 1px solid var(--color-border);
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .google-icon {
            width: 24px;
            height: 24px;
            margin-right: 5px;
        }

        .auth-btn {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .auth-btn.login {
            background: var(--color-accent);
        }

        .auth-btn.register {
            background: var(--color-secondary);
        }

        /* Bot√≥n de configuraci√≥n flotante */
        .settings-btn-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .settings-btn {
            width: var(--settings-btn-size);
            height: var(--settings-btn-size);
            border-radius: 50%;
            background: var(--color-accent);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            position: relative;
        }

        .settings-btn:hover {
            transform: scale(1.1) rotate(30deg);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .settings-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: calc(100% + 10px);
            white-space: nowrap;
            background: transparent;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            font-family: 'Audiowide', cursive;
            overflow: hidden;
            width: 0;
        }

        .settings-btn:hover::after {
            opacity: 1;
            width: 100%;
            animation: typing 0.5s steps(12) forwards;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        .settings-icon {
            font-size: 1.5rem;
            color: white;
        }

        .settings-menu {
            position: absolute;
            bottom: calc(var(--settings-btn-size) + 10px);
            right: 0;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 10px 0;
            min-width: 250px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1001;
            border: 1px solid var(--color-border);
        }

        .settings-menu.active {
            display: block;
        }

        .settings-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--color-text);
            position: relative; /* Added for sub-options positioning */
        }

        .settings-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .settings-item.logout {
            color: var(--color-danger);
        }

        .theme-options, .role-options, .notification-settings {
            display: none;
            flex-direction: column;
            padding: 10px;
            gap: 5px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            margin: 5px;
            position: absolute; 
            right: calc(100% + 20px); /* Aumentado el espacio */
            top: 50%; /* Centrado verticalmente */
            transform: translateY(-50%); /* Ajuste para centrar */
            min-width: 200px;
            z-index: 1002; 
        }

        .theme-options.active, .role-options.active, .notification-settings.active {
            display: flex;
        }

        .theme-option, .role-option {
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid var(--color-border);
            transition: all 0.3s;
            color: white;
            text-align: center;
            position: relative;
        }

        .theme-option:hover, .role-option:hover {
            transform: scale(1.02);
        }

        .theme-option.active::after, .role-option.active::after {
            content: '‚úì';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
        }

        /* Di√°logo personalizado */
        .custom-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            z-index: 1100;
            display: none;
            flex-direction: column;
            align-items: center;
            border: 1px solid var(--color-border);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            max-width: 80%;
            width: 300px;
            font-family: 'Audiowide', cursive;
        }

        .custom-dialog.active {
            display: flex;
        }

        .custom-dialog-message {
            margin-bottom: 20px;
            text-align: center;
        }

        .custom-dialog-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .custom-dialog-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Audiowide', cursive;
        }

        .custom-dialog-btn.confirm {
            background: var(--color-danger);
            color: white;
        }

        .custom-dialog-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text);
        }

        .custom-dialog-btn:hover {
            opacity: 0.9;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            padding-top: var(--header-height);
        }

        /* Logo y t√≠tulo - Solo 'LOUVLE' con Audiowide */
        .logo-title {
            font-family: 'Audiowide', cursive;
            font-size: 1.8rem;
            color: var(--color-text);
            text-align: center;
            padding: 20px 0 10px 0;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 20px;
        }

        /* T√≠tulos de secci√≥n sin Audiowide */
        .sidebar-title, .modal-title, .section-title, .app-title {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Men√∫ lateral */
        .sidebar {
            width: 250px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            padding: 0 20px 20px 20px;
            transition: transform 0.3s;
            border-right: 1px solid var(--color-border);
            position: relative;
            z-index: 10;
            display: flex; /* A√±adido para flexbox */
            flex-direction: column; /* A√±adido para flexbox */
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sidebar-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-text);
            /* Removed Audiowide from here as per request */
        }

        .close-sidebar {
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
        }

        .materias-list, .groups-list {
            overflow-y: auto;
            max-height: calc(100vh - 220px);
        }

        .materia-item, .group-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: var(--color-bg-input);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .materia-item:hover, .group-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .materia-item.active, .group-item.active {
            background: var(--color-accent);
            font-weight: bold;
        }

        .materia-info, .group-info {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
            color: var(--color-text-secondary);
        }

        .materia-actions, .group-actions {
            display: none;
        }

        .materia-item:hover .materia-actions, .group-item:hover .group-actions {
            display: flex;
            gap: 5px;
        }

        .materia-btn, .group-btn {
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            font-size: 0.8rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .materia-btn.eliminar, .group-btn.eliminar {
            background: var(--color-danger);
        }

        .materia-btn.eliminar:hover, .group-btn.eliminar:hover {
            background: #c82333;
        }

        .add-materia-btn, .add-group-btn {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: var(--color-accent);
            border: none;
            border-radius: 8px;
            color: var(--color-text);
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            /* Removed Audiowide from here as per request */
        }

        .add-materia-btn:hover, .add-group-btn:hover {
            background: #002343;
        }

        /* Login info */
        .login-info {
            position: relative; /* Cambiado a relative */
            margin-top: auto; /* Empuja el elemento hacia abajo */
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            width: 100%; /* Asegura que ocupe el ancho completo */
            box-sizing: border-box; /* Incluye padding y border en el ancho */
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: white;
            padding: 2px;
        }

        .user-email {
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            color: var(--color-text);
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            margin-left: 10px;
        }

        /* Contenido principal */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
        }

        .app-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--color-text);
            /* Removed Audiowide from here as per request */
        }

        /* Tareas */
        .tareas-container, .notes-container, .group-members-container {
            background: var(--color-bg-input);
            backdrop-filter: blur(5px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text);
            /* Removed Audiowide from here as per request */
        }

        .tarea-item, .note-item, .member-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            animation: fadeIn 0.5s ease-out;
        }

        .tarea-item:last-child, .note-item:last-child, .member-item:last-child {
            margin-bottom: 0;
        }

        .tarea-info, .note-info, .member-info {
            flex: 1;
        }

        .tarea-title, .note-title, .member-name {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            color: var(--color-text);
        }

        .tarea-prioridad {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .prioridad-alta {
            background-color: #710101;
        }

        .prioridad-normal {
            background-color: #153704;
        }

        .tarea-descripcion, .note-content, .member-email {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
            color: var(--color-text-secondary);
        }

        .tarea-fecha, .note-date {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }

        .tarea-puntos {
            background: var(--color-accent);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
            color: white;
        }

        .tarea-actions, .note-actions, .member-actions {
            display: flex;
            gap: 10px;
        }

        /* Modernized buttons */
        .tarea-btn, .note-btn, .member-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem; /* Adjust icon size */
        }

        .tarea-btn:hover, .note-btn:hover, .member-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .tarea-btn.completar {
            background: var(--color-success);
        }

        .tarea-btn.completar:hover {
            background: #218838;
        }

        .tarea-btn.eliminar, .note-btn.eliminar, .member-btn.remove {
            background: var(--color-danger);
        }

        .tarea-btn.eliminar:hover, .note-btn.eliminar:hover, .member-btn.remove:hover {
            background: #ff6b81;
        }

        .tarea-btn.editar, .note-btn.editar {
            background: var(--color-warning);
        }

        .tarea-btn.editar:hover, .note-btn.editar:hover {
            background: #e0a800;
        }

        .note-attachments a {
            color: var(--color-dark);
            text-decoration: none;
            margin-right: 10px;
        }

        /* Modales */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s;
            border: 1px solid var(--color-border);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-text);
            /* Removed Audiowide from here as per request */
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-text);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .form-control.error {
            border-color: var(--color-danger);
            animation: vibrate 0.5s;
        }

        .error-message {
            color: var(--color-danger);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        .tipo-tarea {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tipo-tarea-btn {
            flex: 1;
            padding: 10px;
            background: var(--color-bg-input);
            border: none;
            border-radius: 8px;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.3s;
        }

        .tipo-tarea-btn.active {
            background: var(--color-accent);
            font-weight: bold;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            /* Removed Audiowide from here as per request */
        }

        .btn-primary {
            background: var(--color-accent);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #4f84ff;
            transform: translateY(-2px);
        }

        /* Secci√≥n de tareas completadas */
        .tareas-completadas-container {
            background: var(--color-bg-input);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .tarea-completada {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tarea-completada.entregada {
            background: rgba(40, 167, 69, 0.2);
            text-decoration: line-through;
        }

        .tarea-completada.no-entregada {
            background: rgba(220, 53, 69, 0.2);
            text-decoration: line-through;
        }

        .tarea-completada-info {
            flex: 1;
        }

        .tarea-completada-status {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .entregada-text {
            color: var(--color-success);
        }

        .no-entregada-text {
            color: var(--color-danger);
        }

        /* Login */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 1;
            /* MODIFICACI√ìN: Ocultar por defecto para evitar parpadeo */
            display: none; 
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            position: relative;
            z-index: 2;
            border: 1px solid var(--color-border);
        }

        .login-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            /* Removed Audiowide from here as per request */
            color: var(--color-text);
        }

        .auth-options {
            width: 100%;
            margin-top: 20px;
        }

        .login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            background: #4285F4;
            color: white;
            /* Removed Audiowide from here as per request */
        }

        .login-btn:hover {
            background: #3367D6;
        }

        .login-btn img {
            width: 20px;
            height: 20px;
            background: white;
            padding: 5px;
            border-radius: 50%;
        }

        .skip-btn {
            background: none;
            border: none;
            color: var(--color-text);
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 5px;
            /* Removed Audiowide from here as per request */
        }

        .skip-btn:hover {
            color: #ffffff;
        }

        .terms {
            margin-top: 20px;
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            text-align: center;
        }

        .terms-link {
            color: var(--color-text);
            text-decoration: none;
        }

        .terms-link:hover {
            text-decoration: underline;
        }

        /* Notificaciones */
        .notificacion {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1001;
            animation: fadeIn 0.3s ease-out;
            /* Removed Audiowide from here as per request */
        }

        /* Configuraci√≥n de notificaciones mejorada */
        .notification-setting {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        .notification-setting label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .notification-setting select, 
        .notification-setting input {
            padding: 5px;
            border-radius: 5px;
            background: var(--color-bg-input);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            min-width: 80px;
        }

        .time-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .time-inputs input {
            width: 60px;
            padding: 8px;
            text-align: center;
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text);
        }

        .time-inputs span {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }

        @keyframes vibrate {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0; /* Ajustado para que abarque la parte superior */
                left: 0;
                height: 100vh; /* Ajustado para que abarque toda la altura */
                z-index: 100;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .close-sidebar {
                display: block;
            }

            .menu-btn {
                display: block;
            }
            
            .background-image {
                background-size: 60%;
            }
            
            .notification-setting {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .time-inputs {
                width: 100%;
                justify-content: space-between;
            }

            .fixed-buttons-container {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                padding: 10px;
            }

          .settings-item {
            position: relative; /* Cambiamos a relativo para m√≥vil */
        }

        .theme-options, 
        .role-options, 
        .notification-settings {
            position: fixed; /* Fijo en la pantalla */
            top: 50% !important;
            left: 50% !important;
            right: auto !important;
            bottom: auto !important;
            transform: translate(-50%, -50%) !important;
            width: 90%;
            max-width: 280px;
            background: var(--color-primary) !important;
            border: 2px solid var(--color-accent);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
            z-index: 2000;
            max-height: 70vh;
            overflow-y: auto;
        }

            .join-group-input {
                flex-direction: column;
                gap: 8px;
            }

            .join-group-input input {
                width: 100%;
                padding: 8px;
            }

            #join-group-btn {
                width: 100%;
                padding: 8px;
                font-size: 0.9rem;
            }
            .group-members-list {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 8px;
                padding: 10px;
                margin-top: 10px;
            }

            .member-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid var(--color-border);
            }

            .member-info {
                text-align: right;
                flex: 1;
            }

            .member-name {
                font-weight: bold;
                font-size: 0.9rem;
            }

            .member-email {
                font-size: 0.75rem;
                color: var(--color-text-secondary);
            }
        }

        /* Temas de color */
        .theme-dark {
            --color-primary: #050916;
            --color-secondary: #0b5657;
            --color-accent: #0d3430;
            --color-light: #ffffff;
            --color-dark: #0080ff;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #032711;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-light {
            --color-primary: #f5f5f5;
            --color-secondary: #e0e0e0;
            --color-accent: #4a90e2;
            --color-light: #333333;
            --color-dark: #2c3e50;
            --color-success: #2ecc71;
            --color-danger: #e74c3c;
            --color-warning: #f39c12;
            --color-info: #3498db;
            --color-text: #333333;
            --color-text-secondary: rgba(51, 51, 51, 0.7);
            --color-bg-input: rgba(0, 0, 0, 0.05);
            --color-border: rgba(0, 0, 0, 0.1);
        }

        .theme-purple {
            --color-primary: #1a0933;
            --color-secondary: #3d1a68;
            --color-accent: #6a3093;
            --color-light: #ffffff;
            --color-dark: #9b59b6;
            --color-success: #27ae60;
            --color-danger: #e74c3c;
            --color-warning: #f39c12;
            --color-info: #3498db;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-blue {
            --color-primary: #0a192f;
            --color-secondary: #172a45;
            --color-accent: #1e4d8c;
            --color-light: #ffffff;
            --color-dark: #64ffda;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #17a2b8;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-green {
            --color-primary: #0d1f0c;
            --color-secondary: #1a3a1a;
            --color-accent: #2a5e2a;
            --color-light: #ffffff;
            --color-dark: #4caf50;
            --color-success: #2e7d32;
            --color-danger: #c62828;
            --color-warning: #f9a825;
            --color-info: #0277bd;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-red {
            --color-primary: #1a0000;
            --color-secondary: #4a0000;
            --color-accent: #8b0000;
            --color-light: #ffffff;
            --color-dark: #ff4444;
            --color-success: #00c851;
            --color-danger: #ff4444;
            --color-warning: #ffbb33;
            --color-info: #33b5e5;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-midnight {
            --color-primary: #0a0e17;
            --color-secondary: #1a2138;
            --color-accent: #2a3a5e;
            --color-light: #ffffff;
            --color-dark: #6c8ae4;
            --color-success: #00b894;
            --color-danger: #d63031;
            --color-warning: #fdcb6e;
            --color-info: #0984e3;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-ocean {
            --color-primary: #001f3f;
            --color-secondary: #003366;
            --color-accent: #0074d9;
            --color-light: #ffffff;
            --color-dark: #7fdbff;
            --color-success: #2ecc40;
            --color-danger: #ff4136;
            --color-warning: #ffdc00;
            --color-info: #39cccc;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-forest {
            --color-primary: #0d2601;
            --color-secondary: #1a4003;
            --color-accent: #2a6607;
            --color-light: #ffffff;
            --color-dark: #4d9900;
            --color-success: #2e7d32;
            --color-danger: #c62828;
            --color-warning: #f9a825;
            --color-info: #0277bd;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        .theme-black-white {
            --color-primary: #000000;
            --color-secondary: #333333;
            --color-accent: #666666;
            --color-light: #ffffff;
            --color-dark: #999999;
            --color-success: #00c851;
            --color-danger: #ff4444;
            --color-warning: #ffbb33;
            --color-info: #2f2f2f;
            --color-text: #ffffff;
            --color-text-secondary: rgba(255, 255, 255, 0.7);
            --color-bg-input: rgba(255, 255, 255, 0.1);
            --color-border: rgba(255, 255, 255, 0.2);
        }

        /* Fixed buttons container */
        .fixed-buttons-container {
            position: sticky;
            top: var(--header-height); /* Adjust based on header height */
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            gap: 10px;
            z-index: 999;
            border-bottom: 1px solid var(--color-border);
        }

        .fixed-buttons-container button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .fixed-buttons-container button:hover {
            opacity: 0.9;
        }

        .fixed-buttons-container .btn-tarea {
            background: var(--color-accent);
        }

        .fixed-buttons-container .btn-examen {
            background: var(--color-info);
        }

        .fixed-buttons-container .btn-nota {
            background: var(--color-warning);
        }

        /* Role selection modal */
        .role-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1200;
            display: none;
        }

        .role-selection-content {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 1px solid var(--color-border);
        }

        .role-selection-content h2 {
            margin-bottom: 20px;
            color: var(--color-text);
        }

        .role-selection-content .form-group {
            margin-bottom: 20px;
        }

        .role-selection-content .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .role-selection-content .btn-group button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .role-selection-content .btn-group .btn-teacher {
            background: var(--color-accent);
            color: white;
        }

        .role-selection-content .btn-group .btn-student {
            background: var(--color-secondary);
            color: white;
        }

        .role-selection-content .btn-group button:hover {
            opacity: 0.9;
        }

        /* Group specific styles */
        .group-code-display {
            background: var(--color-bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            word-break: break-all;
            display: flex;
            flex-direction: column; /* Changed to column for better layout */
            justify-content: space-between;
            align-items: flex-start; /* Align items to start */
            gap: 10px; /* Space between elements */
        }

        .group-code-display .code-text {
            font-weight: bold;
            color: var(--color-text);
        }

        .group-code-display .copy-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .group-code-display button {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 8px 15px; /* Increased padding */
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem; /* Adjusted font size */
        }

        .copy-url-btn {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .copy-url-btn:hover {
            background: var(--color-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .copy-url-btn i {
            font-size: 1rem;
        }

        .group-code-display .info-message {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            margin-top: 5px;
        }

       .join-group-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .join-group-input input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            background: var(--color-bg-input);
            color: var(--color-text);
        }

        .small-join-btn {
            padding: 4px 8px; 
            font-size: 0.8rem; 
            height: auto;
        }

       .join-group-input button {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 0 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .join-group-input button:hover {
            background: var(--color-dark);
        }

        .file-upload-container {
            margin-top: 15px;
            padding: 10px;
            border: 1px dashed var(--color-border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }

        .file-upload-container:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .file-list {
            margin-top: 10px;
            max-height: 100px;
            overflow-y: auto;
        }

        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px 10px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .file-list-item span {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-list-item button {
            background: none;
            border: none;
            color: var(--color-danger);
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
        }

        /* Progress bar for file upload */
        .upload-progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin-top: 10px;
            display: none; /* Hidden by default */
        }

        .upload-progress-bar {
            width: 0%;
            height: 20px;
            background-color: var(--color-accent);
            border-radius: 5px;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="theme-dark">
    <!-- Imagen de fondo fija -->
    <div class="background-image"></div>

    <!-- Header superior -->
    <div class="top-header">
        <div class="auth-buttons" id="auth-buttons">
            <img src="googleimg.png" class="google-icon" alt="Google">
            <button class="auth-btn login" id="header-login-btn">Iniciar sesi√≥n</button>
            <button class="auth-btn register" id="header-register-btn">Registrarme</button>
        </div>
    </div>

    <!-- Bot√≥n de configuraci√≥n flotante -->
    <div class="settings-btn-container">
        <button class="settings-btn" id="settings-btn" title="Configuraci√≥n">
            <i class="fas fa-cog settings-icon"></i>
        </button>   
        <div class="settings-menu" id="settings-menu">
            <div class="settings-item" id="change-theme-btn">
                <span>Cambiar tema</span>
                <span>üé®</span>
                <div class="theme-options" id="theme-options">
                    <div class="theme-option" data-theme="dark" style="background: #0d3430; color: white;">Original</div>
                    <div class="theme-option" data-theme="light" style="background: #f5f5f5; color: #333;">Claro</div>
                    <div class="theme-option" data-theme="purple" style="background: #1a0933; color: white;">Morado</div>
                    <div class="theme-option" data-theme="blue" style="background: #0a192f; color: white;">Azul</div>
                    <div class="theme-option" data-theme="green" style="background: #0d1f0c; color: white;">Verde</div>
                    <div class="theme-option" data-theme="red" style="background: #1a0000; color: white;">Rojo</div>
                    <div class="theme-option" data-theme="midnight" style="background: #0a0e17; color: white;">Medianoche</div>
                    <div class="theme-option" data-theme="ocean" style="background: #001f3f; color: white;">Oc√©ano</div>
                    <div class="theme-option" data-theme="forest" style="background: #0d2601; color: white;">Bosque</div>
                    <div class="theme-option" data-theme="black-white" style="background: #000000; color: white;">Blanco y Negro</div>
                </div>
            </div>
            
            <div class="settings-item" id="notification-settings-btn">
                <span>Configurar notificaciones</span>
                <span>üîî</span>
                <div class="notification-settings" id="notification-settings">
                    <div class="notification-setting">
                        <label>Recordatorio tareas normales:</label>
                        <div class="time-inputs">
                            <input type="number" id="reminder-normal-days" min="0" value="1" placeholder="D√≠as">
                            <span>d√≠as </span>
                            <input type="number" id="reminder-normal-hours" min="0" max="23" value="0" placeholder="Horas">
                            <span>horas</span>
                        </div>
                    </div>
                    <div class="notification-setting">
                        <label>Recordatorio alta prioridad:</label>
                        <div class="time-inputs">
                            <input type="number" id="reminder-high-days" min="0" value="3" placeholder="D√≠as">
                            <span>d√≠as </span>
                            <input type="number" id="reminder-high-hours" min="0" max="23" value="0" placeholder="Horas">
                            <span>horas</span>
                        </div>
                    </div>
                    
                    <div class="notification-setting">
                        <label>Recordatorio ex√°menes:</label>
                        <div class="time-inputs">
                            <input type="number" id="reminder-exam-days" min="0" value="2" placeholder="D√≠as">
                            <span>d√≠as </span>
                            <input type="number" id="reminder-exam-hours" min="0" max="23" value="0" placeholder="Horas">
                            <span>horas</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-item" id="change-role-btn">
                <span>Cambiar Rol (Solo para pruebas)</span>
                <span>üé≠</span>
                <div class="role-options" id="role-options">
                    <div class="role-option" data-role="teacher">Maestro</div>
                    <div class="role-option" data-role="student">Alumno</div>
                </div>
            </div>
            
            <div class="settings-item" id="add-google-account">
                <span>Agregar cuenta de Google</span>
                <span>‚ûï</span>
            </div>
            <div class="settings-item logout" id="logout-menu-btn">
                <span>Cerrar sesi√≥n</span>
                <span>üö™</span>
            </div>
            <div class="settings-item delete-account" id="delete-account-btn">
                <span>Eliminar cuenta</span>
                <span>üóëÔ∏è</span>
            </div>
        </div>
    </div>

    <!-- Di√°logo personalizado para confirmaciones -->
    <div class="custom-dialog" id="confirm-dialog">
        <div class="custom-dialog-message" id="confirm-message">¬øEst√°s seguro de que quieres eliminar esta tarea?</div>
        <div class="custom-dialog-buttons">
            <button class="custom-dialog-btn cancel" id="confirm-cancel">Cancelar</button>
            <button class="custom-dialog-btn confirm" id="confirm-ok">Eliminar</button>
        </div>
    </div>

    <!-- Di√°logo de confirmaci√≥n para cerrar sesi√≥n -->
    <div class="custom-dialog" id="logout-dialog">
        <div class="custom-dialog-message">¬øEst√°s seguro que quieres cerrar sesi√≥n en esta cuenta?</div>
        <div class="custom-dialog-buttons">
            <button class="custom-dialog-btn cancel" id="logout-cancel">Cancelar</button>
            <button class="custom-dialog-btn confirm" id="logout-confirm">Cerrar sesi√≥n</button>
        </div>
    </div>

    <!-- Di√°logo de confirmaci√≥n para eliminar cuenta -->
    <div class="custom-dialog" id="delete-account-dialog">
        <div class="custom-dialog-message">¬øEst√°s seguro que quieres eliminar tu cuenta? Esta acci√≥n es irreversible y borrar√° todos tus datos.</div>
        <div class="custom-dialog-buttons">
            <button class="custom-dialog-btn cancel" id="delete-account-cancel">Cancelar</button>
            <button class="custom-dialog-btn confirm" id="delete-account-confirm">Eliminar cuenta</button>
        </div>
    </div>

    <!-- Modal de selecci√≥n de rol y nombre completo -->
    <div class="role-selection-modal" id="role-selection-modal">
        <div class="role-selection-content">
            <h2>¬°Bienvenido!</h2>
            <p>Por favor, dinos tu nombre completo y tu rol:</p>
            <div class="form-group">
                <label for="full-name-input">Nombre Completo</label>
                <input type="text" id="full-name-input" class="form-control" placeholder="Tu nombre completo" required>
                <div class="error-message" id="error-full-name">Este campo es obligatorio</div>
            </div>
            <div class="btn-group">
                <button class="btn-teacher" data-role="teacher" id="select-teacher-role">Soy Maestro</button>
                <button class="btn-student" data-role="student" id="select-student-role">Soy Alumno</button>
            </div>
        </div>
    </div>

    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h1 class="login-title">LOUVLE</h1>
            <p>Organiza tus tareas acad√©micas de manera eficiente</p>
            
            <div class="auth-options">
                <button id="google-login" class="login-btn">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google">
                    Iniciar sesi√≥n con Google
                </button>
                
                <button id="skip-login" class="skip-btn">
                    O continuar sin cuenta
                </button>
                
                <div class="terms">
                    Al continuar, aceptas nuestros <a href="#" class="terms-link">T√©rminos de Servicio</a> y <a href="#" class="terms-link">Pol√≠tica de Privacidad</a>.
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="app-container">
        <!-- Men√∫ lateral -->
        <div class="sidebar" id="sidebar">
            <div class="logo-title">LOUVLE</div>
            
            <div class="sidebar-header">
                <div class="sidebar-title" id="sidebar-title-materias">Materias</div>
                <button class="close-sidebar" id="close-sidebar">√ó</button>
            </div>
            
            <div class="materias-list" id="materias-list"></div>
            <button class="add-materia-btn" id="abrir-modal-materia">+ Nueva Materia</button>

            <!-- Secci√≥n de Grupos (visible para ambos roles) -->
            <div id="groups-section">
                <div class="sidebar-header" style="margin-top: 20px;">
                    <div class="sidebar-title">Grupos</div>
                </div>
                <div class="groups-list" id="groups-list"></div>
                <div class="join-group-input">
                    <input type="text" id="join-group-code" placeholder="Pega el c√≥digo del grupo">
                    <button id="join-group-btn">‚úî</button>
                </div>
                <button class="add-group-btn" id="abrir-modal-group" style="display: none;">+ Nuevo Grupo</button>
            </div>
            
            <!-- Information about the selected group -->
            <div id="group-details-section" style="display: none; margin-top: 20px;">
                <div class="sidebar-header" style="cursor: pointer;" id="toggle-members-btn">
                    <div class="sidebar-title">Miembros del Grupo <i class="fas fa-chevron-down" id="members-arrow"></i></div>
                </div>
                <div class="group-members-list" id="group-members-list" style="display: none; max-height: 200px; overflow-y: auto;"></div>
            </div>
            
            <!-- Informaci√≥n de login -->
            <div class="login-info" id="login-info">
                <img id="user-avatar" class="user-avatar" src="" alt="Foto de perfil">
                <div id="user-email" class="user-email"></div>
                <button class="logout-btn" id="logout-btn" title="Cerrar sesi√≥n">‚úï</button>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="main-content">
            <div class="header">
                <button class="menu-btn" id="menu-btn">‚ò∞</button>
                <h1 class="app-title">Organizador Acad√©mico</h1>
            </div>

            <!-- Teacher Group Code Display -->
            <div id="teacher-group-code-display" class="group-code-display" style="display: none;">
                <div class="copy-container">
                    <button class="copy-url-btn" id="copy-current-group-code">
                        <i class="fas fa-copy"></i> Copiar C√≥digo de Invitaci√≥n
                    </button>
                    <span class="info-message" id="copy-code-message" style="display: none;">Cualquiera con este c√≥digo puede unirse a su grupo, incluidos los alumnos.</span>
                </div>
            </div>

            <!-- Fixed buttons for adding tasks, exams, notes -->
            <div class="fixed-buttons-container" id="fixed-buttons-container">
                <button class="btn-tarea" id="abrir-modal-tarea">+ Nueva Tarea</button>
                <button class="btn-examen" id="abrir-modal-examen">+ Nuevo Examen</button>
                <button class="btn-nota" id="abrir-modal-nota">+ Nueva Nota</button>
            </div>

            <!-- Tareas pendientes -->
            <div class="tareas-container" id="tareas-pendientes-container">
                <h2 class="section-title" id="titulo-tareas">Tareas Pendientes</h2>
                <div id="lista-tareas-pendientes"></div>
            </div>

            <!-- Ex√°menes pendientes -->
            <div class="tareas-container" id="examenes-pendientes-container">
                <h2 class="section-title">Ex√°menes Pendientes</h2>
                <div id="lista-examenes-pendientes"></div>
            </div>

            <!-- Notas -->
            <div class="notes-container" id="notes-container">
                <h2 class="section-title">Notas</h2>
                <div id="lista-notas"></div>
            </div>

            <!-- Tareas completadas -->
            <div class="tareas-completadas-container" id="tareas-completadas-container">
                <h2 class="section-title">Tareas Completadas</h2>
                <div id="lista-tareas-completadas"></div>
            </div>

            <!-- Ex√°menes completados -->
            <div class="tareas-completadas-container" id="examenes-completados-container">
                <h2 class="section-title">Ex√°menes Realizados</h2>
                <div id="lista-examenes-completados"></div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar materia -->
    <div class="modal" id="modal-materia">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nueva Materia</h2>
                <button class="close-modal" id="cerrar-modal-materia">√ó</button>
            </div>
            <div class="form-group">
                <label for="nombre-materia">Nombre de la materia</label>
                <input type="text" id="nombre-materia" class="form-control" placeholder="Ej: Matem√°ticas" required>
                <div class="error-message" id="error-nombre-materia">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="zona-materia">Puntos de zona</label>
                <input type="number" id="zona-materia" class="form-control" placeholder="Ej: 40" min="1" required>
                <div class="error-message" id="error-zona-materia">Este campo es obligatorio</div>
            </div>
            <button class="btn btn-primary" id="guardar-materia">Guardar</button>
        </div>
    </div>

    <!-- Modal para agregar/editar tarea -->
    <div class="modal" id="modal-tarea">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-tarea-title">Nueva Tarea</h2>
                <button class="close-modal" id="cerrar-modal-tarea">√ó</button>
            </div>
            <div class="form-group">
                <label for="tarea-descripcion">Descripci√≥n</label>
                <input type="text" id="tarea-descripcion" class="form-control" placeholder="Ej: Hacer ejercicios de √°lgebra" required>
                <div class="error-message" id="error-tarea-descripcion">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="tarea-puntos">Puntos</label>
                <input type="number" id="tarea-puntos" class="form-control" placeholder="Ej: 10" min="1" required>
                <div class="error-message" id="error-tarea-puntos">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="tarea-fecha">Fecha de entrega</label>
                <input type="date" id="tarea-fecha" class="form-control" required>
                <div class="error-message" id="error-tarea-fecha">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="tarea-prioridad"> Prioridad alta
                </label>
            </div>
            <div class="form-group" id="tarea-status-group">
                <label>Estado</label>
                <div>
                    <label>
                        <input type="radio" name="tarea-status" value="entregada" checked> Entregada
                    </label>
                    <label>
                        <input type="radio" name="tarea-status" value="no-entregada"> No entregada
                    </label>
                </div>
            </div>
            <button class="btn btn-primary" id="guardar-tarea">Guardar</button>
            <button class="btn btn-primary" id="cancelar-tarea" style="background: var(--color-danger); margin-top: 10px;">Cancelar Tarea</button>
        </div>
    </div>

    <!-- Modal para agregar/editar examen -->
    <div class="modal" id="modal-examen">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-examen-title">Nuevo Examen</h2>
                <button class="close-modal" id="cerrar-modal-examen">√ó</button>
            </div>
            <div class="form-group">
                <label for="examen-descripcion">Descripci√≥n</label>
                <input type="text" id="examen-descripcion" class="form-control" placeholder="Ej: Examen parcial de √°lgebra" required>
                <div class="error-message" id="error-examen-descripcion">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="examen-puntos">Puntos</label>
                <input type="number" id="examen-puntos" class="form-control" placeholder="Ej: 30" min="1" required>
                <div class="error-message" id="error-examen-puntos">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="examen-fecha">Fecha del examen</label>
                <input type="date" id="examen-fecha" class="form-control" required>
                <div class="error-message" id="error-examen-fecha">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="examen-utiles">√ötiles necesarios</label>
                <input type="text" id="examen-utiles" class="form-control" placeholder="Ej: Calculadora, cuaderno, libro">
            </div>
            <div class="form-group" id="examen-status-group">
                <label>Estado</label>
                <div>
                    <label>
                        <input type="radio" name="examen-status" value="realizado" checked> Realizado
                    </label>
                    <label>
                        <input type="radio" name="examen-status" value="no-realizado"> No realizado
                    </label>
                </div>
            </div>
            <button class="btn btn-primary" id="guardar-examen">Guardar</button>
        </div>
    </div>

    <!-- Modal para agregar/editar nota -->
    <div class="modal" id="modal-nota">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-nota-title">Nueva Nota</h2>
                <button class="close-modal" id="cerrar-modal-nota">√ó</button>
            </div>
            <div class="form-group">
                <label for="nota-titulo">T√≠tulo</label>
                <input type="text" id="nota-titulo" class="form-control" placeholder="Ej: Recordatorio importante" required>
                <div class="error-message" id="error-nota-titulo">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="nota-contenido">Contenido</label>
                <textarea id="nota-contenido" class="form-control" rows="5" placeholder="Escribe tu nota aqu√≠..."></textarea>
            </div>
            <div class="form-group">
                <label for="nota-archivos">Adjuntar Archivos</label>
                <div class="file-upload-container" id="file-upload-container">
                    <i class="fas fa-cloud-upload-alt"></i> Arrastra y suelta archivos aqu√≠ o haz clic para seleccionar
                    <input type="file" id="nota-archivos" multiple style="display: none;">
                </div>
                <div class="upload-progress-container" id="upload-progress-container">
                    <div class="upload-progress-bar" id="upload-progress-bar">0%</div>
                </div>
                <div class="file-list" id="nota-file-list"></div>
            </div>
            <button class="btn btn-primary" id="guardar-nota">Guardar</button>
        </div>
    </div>

    <!-- Modal para crear/editar grupo -->
    <div class="modal" id="modal-group">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-group-title">Nuevo Grupo</h2>
                <button class="close-modal" id="cerrar-modal-group">√ó</button>
            </div>
            <div class="form-group">
                <label for="group-name">Nombre del Grupo</label>
                <input type="text" id="group-name" class="form-control" placeholder="Ej: Grupo de √Ålgebra" required>
                <div class="error-message" id="error-group-name">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="group-description">Descripci√≥n (Opcional)</label>
                <textarea id="group-description" class="form-control" rows="3" placeholder="Una breve descripci√≥n del grupo"></textarea>
            </div>
            <div id="group-code-display" class="group-code-display" style="display: none;">
                <div class="code-text">C√≥digo del Grupo: <span id="generated-group-code"></span></div>
                <div class="copy-container">
                    <button id="copy-group-code">Copiar</button>
                    <span class="info-message" id="group-code-info-message" style="display: none;">Cualquiera con este c√≥digo puede unirse a su grupo, incluidos los alumnos.</span>
                </div>
            </div>
            <button class="btn btn-primary" id="save-group">Guardar</button>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCjPPKnktrMBmdeOSvus8V5IF4Ce0qEL4Q",
            authDomain: "louvle.firebaseapp.com",
            projectId: "louvle",
            storageBucket: "louvle.appspot.com",
            messagingSenderId: "461018835077",
            appId: "1:461018835077:web:a91eda8324062fd9b161ec",
            measurementId: "G-3W8C962ZG1"
        };

        // Inicializar Firebase con persistencia
        const firebaseApp = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Habilitar persistencia con manejo de errores
        db.enablePersistence({ synchronizeTabs: true })
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log("Persistencia fall√≥ - M√∫ltiples pesta√±as abiertas");
                } else if (err.code == 'unimplemented') {
                    console.log("Persistencia no soportada en este navegador");
                }
            });

        // Configurar proveedor de Google
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        });

        // Variables globales
        let materias = [];
        let tareas = [];
        let examenes = [];
        let notes = [];
        let groups = [];
        let materiaSeleccionada = null;
        let groupSeleccionado = null;
        let tareaEditando = null;
        let examenEditando = null;
        let noteEditando = null;
        let groupEditando = null;
        let usuario = null;
        let notificaciones = [];
        let usandoFirebase = false;
        let confirmCallback = null;
        let notificationSettings = {
            normal: { days: 1, hours: 0 },
            high: { days: 3, hours: 0 },
            exam: { days: 2, hours: 0 }
        };
        let userRole = null; // 'teacher' or 'student'
        let userFullName = null;
        let currentFiles = []; // For note attachments

        // Elementos del DOM
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const googleLoginBtn = document.getElementById('google-login');
        const skipLoginBtn = document.getElementById('skip-login');
        const loginInfo = document.getElementById('login-info');
        const userAvatar = document.getElementById('user-avatar');
        const userEmail = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const headerLoginBtn = document.getElementById('header-login-btn');
        const headerRegisterBtn = document.getElementById('header-register-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const changeThemeBtn = document.getElementById('change-theme-btn');
        const themeOptions = document.getElementById('theme-options');
        const notificationSettingsBtn = document.getElementById('notification-settings-btn');
        const notificationSettingsMenu = document.getElementById('notification-settings');
        const addGoogleAccountBtn = document.getElementById('add-google-account');
        const logoutMenuBtn = document.getElementById('logout-menu-btn');
        const authButtons = document.getElementById('auth-buttons');
        const confirmDialog = document.getElementById('confirm-dialog');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmCancel = document.getElementById('confirm-cancel');
        const confirmOk = document.getElementById('confirm-ok');
        const logoutDialog = document.getElementById('logout-dialog');
        const logoutCancel = document.getElementById('logout-cancel');
        const logoutConfirm = document.getElementById('logout-confirm');
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const deleteAccountDialog = document.getElementById('delete-account-dialog');
        const deleteAccountCancel = document.getElementById('delete-account-cancel');
        const deleteAccountConfirm = document.getElementById('delete-account-confirm');
        const reminderNormalDays = document.getElementById('reminder-normal-days');
        const reminderNormalHours = document.getElementById('reminder-normal-hours');
        const reminderHighDays = document.getElementById('reminder-high-days');
        const reminderHighHours = document.getElementById('reminder-high-hours');
        const reminderExamDays = document.getElementById('reminder-exam-days');
        const reminderExamHours = document.getElementById('reminder-exam-hours');
        const changeRoleBtn = document.getElementById('change-role-btn');
        const roleOptions = document.getElementById('role-options');

        // Elementos del DOM adicionales
        const tituloTareas = document.getElementById('titulo-tareas');
        const btnNuevaTarea = document.getElementById('abrir-modal-tarea');
        const btnNuevoExamen = document.getElementById('abrir-modal-examen');
        const btnNuevaNota = document.getElementById('abrir-modal-nota');
        const tareasPendientesContainer = document.getElementById('tareas-pendientes-container');
        const examenesPendientesContainer = document.getElementById('examenes-pendientes-container');
        const notesContainer = document.getElementById('notes-container');
        const tareasCompletadasContainer = document.getElementById('tareas-completadas-container');
        const examenesCompletadosContainer = document.getElementById('examenes-completados-container');
        const materiasList = document.getElementById('materias-list');
        const listaTareasPendientes = document.getElementById('lista-tareas-pendientes');
        const listaExamenesPendientes = document.getElementById('lista-examenes-pendientes');
        const listaNotas = document.getElementById('lista-notas');
        const listaTareasCompletadas = document.getElementById('lista-tareas-completadas');
        const listaExamenesCompletados = document.getElementById('lista-examenes-completados');
        const sidebar = document.getElementById('sidebar');
        const fixedButtonsContainer = document.getElementById('fixed-buttons-container');

        // Role selection modal elements
        const roleSelectionModal = document.getElementById('role-selection-modal');
        const fullNameInput = document.getElementById('full-name-input');
        const selectTeacherRoleBtn = document.getElementById('select-teacher-role');
        const selectStudentRoleBtn = document.getElementById('select-student-role');

        // Group elements (now shared)
        const groupsList = document.getElementById('groups-list');
        const abrirModalGroupBtn = document.getElementById('abrir-modal-group');
        const joinGroupCodeInput = document.getElementById('join-group-code'); 
        const joinGroupBtn = document.getElementById('join-group-btn'); 
        const groupDetailsSection = document.getElementById('group-details-section');
        const groupMembersList = document.getElementById('group-members-list');
        const teacherGroupCodeDisplay = document.getElementById('teacher-group-code-display'); 
        const copyCurrentGroupCodeBtn = document.getElementById('copy-current-group-code'); 
        const copyCodeMessage = document.getElementById('copy-code-message'); 

        // Note modal elements
        const notaArchivosInput = document.getElementById('nota-archivos');
        const notaFileUploadContainer = document.getElementById('file-upload-container');
        const notaFileList = document.getElementById('nota-file-list');
        const uploadProgressContainer = document.getElementById('upload-progress-container');
        const uploadProgressBar = document.getElementById('upload-progress-bar');

        // Group modal elements
        const generatedGroupCode = document.getElementById('generated-group-code');
        const copyGroupCodeBtnModal = document.getElementById('copy-group-code'); 
        const groupCodeInfoMessage = document.getElementById('group-code-info-message');

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            // Ocultar elementos que no deben mostrarse al inicio
            // MODIFICACI√ìN: loginScreen.style.display ya est√° en CSS, no es necesario aqu√≠.
            appContainer.style.display = 'none';
            loginInfo.style.display = 'none';
            tareasPendientesContainer.style.display = 'none';
            examenesPendientesContainer.style.display = 'none';
            notesContainer.style.display = 'none';
            tareasCompletadasContainer.style.display = 'none';
            examenesCompletadosContainer.style.display = 'none';
            fixedButtonsContainer.style.display = 'none';
            document.getElementById('tarea-status-group').style.display = 'none';
            document.getElementById('examen-status-group').style.display = 'none';
            document.getElementById('cancelar-tarea').style.display = 'none';
            groupDetailsSection.style.display = 'none';
            teacherGroupCodeDisplay.style.display = 'none'; 
            
            // Configurar eventos
            configurarEventos();
            configurarServiceWorker();
            
            // Verificar sesi√≥n y cargar datos
            verificarSesion();
            
            // Solicitar permisos para notificaciones
            solicitarPermisosNotificaciones();

            // Handle group join code from localStorage (if user was redirected after login)
            handlePendingGroupJoinCode();
        });

        function handlePendingGroupJoinCode() {
            const pendingGroupJoinCode = localStorage.getItem('pendingGroupJoinCode');
            if (pendingGroupJoinCode) {
                localStorage.removeItem('pendingGroupJoinCode');
                joinGroup(pendingGroupJoinCode);
            }
        }

        function solicitarPermisosNotificaciones() {
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        mostrarNotificacion('Notificaciones activadas');
                    }
                });
            }
        }

        function configurarEventos() {
            // Eventos de autenticaci√≥n
            googleLoginBtn.addEventListener('click', iniciarSesionGoogle);
            skipLoginBtn.addEventListener('click', usarLocalStorage);
            logoutBtn.addEventListener('click', mostrarLogoutDialog);
            headerLoginBtn.addEventListener('click', mostrarLoginScreen);
            headerRegisterBtn.addEventListener('click', mostrarLoginScreen);
            logoutMenuBtn.addEventListener('click', mostrarLogoutDialog);
            addGoogleAccountBtn.addEventListener('click', iniciarSesionGoogle);
            logoutCancel.addEventListener('click', () => logoutDialog.classList.remove('active'));
            logoutConfirm.addEventListener('click', cerrarSesion);
            deleteAccountBtn.addEventListener('click', () => deleteAccountDialog.classList.add('active'));
            deleteAccountCancel.addEventListener('click', () => deleteAccountDialog.classList.remove('active'));
            deleteAccountConfirm.addEventListener('click', eliminarCuenta);
            document.querySelectorAll('#notification-settings input').forEach(input => {
                input.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            });

            // Role selection modal events
            selectTeacherRoleBtn.addEventListener('click', () => selectRole('teacher'));
            selectStudentRoleBtn.addEventListener('click', () => selectRole('student'));

            // Eventos de configuraci√≥n
            settingsBtn.addEventListener('click', toggleSettingsMenu);
            changeThemeBtn.addEventListener('click', toggleThemeOptions);
            notificationSettingsBtn.addEventListener('click', toggleNotificationSettings);
            changeRoleBtn.addEventListener('click', toggleRoleOptions);
            
            // Configurar eventos de temas
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evitar que el clic cierre el men√∫ principal
                    const theme = option.dataset.theme;
                    cambiarTema(theme);
                });
            });

            // Configurar eventos de rol (solo para pruebas)
            document.querySelectorAll('.role-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evitar que el clic cierre el men√∫ principal
                    const role = option.dataset.role;
                    if (usuario && usuario.uid) {
                        updateUserRole(usuario.uid, role);
                    } else {
                        userRole = role;
                        mostrarNotificacion(`Rol cambiado a ${role} (solo localmente)`);
                        renderizarUIporRol();
                    }
                });
            });

            // Eventos del di√°logo de confirmaci√≥n
            confirmCancel.addEventListener('click', () => {
                confirmDialog.classList.remove('active');
            });
            
            confirmOk.addEventListener('click', () => {
                confirmDialog.classList.remove('active');
                if (confirmCallback) {
                    confirmCallback();
                    confirmCallback = null;
                }
            });

             // Configurar eventos de notificaciones
            reminderNormalDays.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            reminderNormalHours.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            reminderHighDays.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            reminderHighHours.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            reminderExamDays.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            reminderExamHours.addEventListener('change', (e) => { e.stopPropagation(); actualizarConfiguracionNotificaciones(); });
            
            // Cerrar men√∫ de configuraci√≥n al hacer clic fuera, pero no si el clic es dentro de un submen√∫
            document.addEventListener('click', (e) => {
                const isClickInsideSettingsMenu = settingsMenu.contains(e.target);
                const isClickInsideSettingsBtn = settingsBtn.contains(e.target);
                const isClickInsideNotificationSettings = notificationSettingsMenu.contains(e.target);
                const isClickInsideThemeOptions = themeOptions.contains(e.target);
                const isClickInsideRoleOptions = roleOptions.contains(e.target);

                // Close settings menu if click is outside the button and the menu itself
                if (!isClickInsideSettingsBtn && !isClickInsideSettingsMenu) {
                    settingsMenu.classList.remove('active');
                    themeOptions.classList.remove('active');
                    roleOptions.classList.remove('active');
                    // Only close notification settings if the click is outside its specific area
                    if (!isClickInsideNotificationSettings) {
                        notificationSettingsMenu.classList.remove('active');
                    }
                }
            });


            // Eventos de materias y tareas
            document.getElementById('abrir-modal-materia').addEventListener('click', () => {
                document.getElementById('modal-materia').dataset.mode = 'add';
                document.getElementById('modal-materia').querySelector('.modal-title').textContent = 'Nueva Materia';
                document.getElementById('nombre-materia').value = '';
                document.getElementById('zona-materia').value = '';
                abrirModal('modal-materia');
            });
            document.getElementById('cerrar-modal-materia').addEventListener('click', () => cerrarModal('modal-materia'));
            document.getElementById('guardar-materia').addEventListener('click', guardarMateria);
            
            // Configurar eventos del sidebar
            const menuBtn = document.getElementById('menu-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            
            if (menuBtn) menuBtn.addEventListener('click', toggleSidebar);
            if (closeSidebarBtn) closeSidebarBtn.addEventListener('click', toggleSidebar);
            
            btnNuevaTarea.addEventListener('click', () => {
                if (!materiaSeleccionada && !groupSeleccionado) {
                    mostrarNotificacion('Selecciona una materia o un grupo primero.');
                    return;
                }
                tareaEditando = null;
                document.getElementById('modal-tarea-title').textContent = 'Nueva Tarea';
                document.getElementById('tarea-status-group').style.display = 'none';
                document.getElementById('cancelar-tarea').style.display = 'none';
                // Limpiar formulario
                document.getElementById('tarea-descripcion').value = '';
                document.getElementById('tarea-puntos').value = '';
                document.getElementById('tarea-fecha').value = '';
                document.getElementById('tarea-prioridad').checked = false;
                abrirModal('modal-tarea');
            });
            
            document.getElementById('cerrar-modal-tarea').addEventListener('click', () => cerrarModal('modal-tarea'));
            document.getElementById('guardar-tarea').addEventListener('click', guardarTarea);
            document.getElementById('cancelar-tarea').addEventListener('click', cancelarTarea);
            
            btnNuevoExamen.addEventListener('click', () => {
                if (!materiaSeleccionada && !groupSeleccionado) {
                    mostrarNotificacion('Selecciona una materia o un grupo primero.');
                    return;
                }
                examenEditando = null;
                document.getElementById('modal-examen-title').textContent = 'Nuevo Examen';
                document.getElementById('examen-status-group').style.display = 'none';
                // Limpiar formulario
                document.getElementById('examen-descripcion').value = '';
                document.getElementById('examen-puntos').value = '';
                document.getElementById('examen-fecha').value = '';
                document.getElementById('examen-utiles').value = '';
                abrirModal('modal-examen');
            });
            
            document.getElementById('cerrar-modal-examen').addEventListener('click', () => cerrarModal('modal-examen'));
            document.getElementById('guardar-examen').addEventListener('click', guardarExamen);

            btnNuevaNota.addEventListener('click', () => {
                if (!materiaSeleccionada && !groupSeleccionado) {
                    mostrarNotificacion('Selecciona una materia o un grupo primero.');
                    return;
                }
                noteEditando = null;
                document.getElementById('modal-nota-title').textContent = 'Nueva Nota';
                document.getElementById('nota-titulo').value = '';
                document.getElementById('nota-contenido').value = '';
                currentFiles = [];
                renderNoteFiles();
                uploadProgressContainer.style.display = 'none'; // Hide progress bar
                uploadProgressBar.style.width = '0%';
                uploadProgressBar.textContent = '0%';
                abrirModal('modal-nota');
            });
            document.getElementById('cerrar-modal-nota').addEventListener('click', () => cerrarModal('modal-nota'));
            document.getElementById('guardar-nota').addEventListener('click', guardarNota);
            notaFileUploadContainer.addEventListener('click', () => notaArchivosInput.click());
            notaArchivosInput.addEventListener('change', handleNoteFileSelect);
            notaFileUploadContainer.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); notaFileUploadContainer.classList.add('dragover'); });
            notaFileUploadContainer.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); notaFileUploadContainer.classList.remove('dragover'); });
            notaFileUploadContainer.addEventListener('drop', handleNoteFileDrop);

            // Group events 
            abrirModalGroupBtn.addEventListener('click', () => {
                if (userRole !== 'teacher') {
                    mostrarNotificacion('Solo los maestros pueden crear grupos.');
                    return;
                }
                document.getElementById('modal-group').dataset.mode = 'add';
                document.getElementById('modal-group-title').textContent = 'Nuevo Grupo';
                document.getElementById('group-name').value = '';
                document.getElementById('group-description').value = '';
                document.getElementById('group-code-display').style.display = 'none';
                groupEditando = null;
                abrirModal('modal-group');
            });
            document.getElementById('cerrar-modal-group').addEventListener('click', () => cerrarModal('modal-group'));
            document.getElementById('save-group').addEventListener('click', guardarGrupo);
            copyGroupCodeBtnModal.addEventListener('click', copyGroupCode); 
            joinGroupBtn.addEventListener('click', joinGroup);
            copyCurrentGroupCodeBtn.addEventListener('click', copyCurrentGroupCode); 

            // Add event listener for 'Enter' key on join-group-code input
            joinGroupCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    joinGroup();
                }
            });
            
            // Cargar tema guardado
            const savedTheme = localStorage.getItem('theme') || 'dark';
            cambiarTema(savedTheme);
            
            // Cargar configuraci√≥n de notificaciones
            cargarConfiguracion();

            // Limit year input to 4 characters
            document.getElementById('tarea-fecha').addEventListener('input', (e) => {
                const year = e.target.value.split('-')[0];
                if (year && year.length > 4) {
                    e.target.value = e.target.value.replace(year, year.substring(0, 4));
                }
            });
            document.getElementById('examen-fecha').addEventListener('input', (e) => {
                const year = e.target.value.split('-')[0];
                if (year && year.length > 4) {
                    e.target.value = e.target.value.replace(year, year.substring(0, 4));
                }
            });
        }

        function actualizarConfiguracionNotificaciones() {
            notificationSettings = {
                normal: {
                    days: parseInt(reminderNormalDays.value) || 0,
                    hours: parseInt(reminderNormalHours.value) || 0
                },
                high: {
                    days: parseInt(reminderHighDays.value) || 0,
                    hours: parseInt(reminderHighHours.value) || 0
                },
                exam: {
                    days: parseInt(reminderExamDays.value) || 0,
                    hours: parseInt(reminderExamHours.value) || 0
                }
            };
            guardarConfiguracion();
        }

        function cambiarTema(theme) {
            document.body.className = `theme-${theme}`;
            localStorage.setItem('theme', theme);
            
            // Marcar el tema activo
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.theme === theme) {
                    option.classList.add('active');
                }
            });
            
            // Actualizar el texto de configuraci√≥n
            settingsBtn.setAttribute('data-theme', theme);
            settingsBtn.style.setProperty('--theme-color', `var(--color-accent)`);

            // Ajuste para el padding-top del app-container despu√©s de iniciar sesi√≥n
            // Esto asegura que el padding se recalcule si el tema cambia y el usuario est√° logueado
            if (document.body.classList.contains('logged-in')) {
                appContainer.style.paddingTop = '0';
            } else {
                appContainer.style.paddingTop = 'var(--header-height)';
            }
        }

        function cargarConfiguracion() {
            const savedSettings = localStorage.getItem('notificationSettings');
            if (savedSettings) {
                notificationSettings = JSON.parse(savedSettings);
                reminderNormalDays.value = notificationSettings.normal.days || 1;
                reminderNormalHours.value = notificationSettings.normal.hours || 0;
                reminderHighDays.value = notificationSettings.high.days || 3;
                reminderHighHours.value = notificationSettings.high.hours || 0;
                reminderExamDays.value = notificationSettings.exam.days || 2;
                reminderExamHours.value = notificationSettings.exam.hours || 0;
            }
        }

        function guardarConfiguracion() {
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
        }

        function toggleSettingsMenu(e) {
            e.stopPropagation();
            settingsMenu.classList.toggle('active');
            // Ajustar la posici√≥n de los submen√∫s para que aparezcan desde arriba
            if (settingsMenu.classList.contains('active')) {
                const settingsItems = settingsMenu.querySelectorAll('.settings-item');
                settingsItems.forEach(item => {
                    const subMenu = item.querySelector('.theme-options, .role-options, .notification-settings');
                    if (subMenu) {
                        subMenu.style.bottom = 'auto'; 
                        subMenu.style.top = '0'; 
                    }
                });
            } else {
                // Close all sub-menus when main menu closes
                themeOptions.classList.remove('active');
                notificationSettingsMenu.classList.remove('active');
                roleOptions.classList.remove('active');
            }
            
            // Configurar el texto que aparece al pasar el mouse
            if (settingsMenu.classList.contains('active')) {
                settingsBtn.setAttribute('data-text', 'Configuraci√≥n');
            } else {
                settingsBtn.setAttribute('data-text', '');
            }
        }

        function toggleThemeOptions(e) {
            e.stopPropagation();
            themeOptions.classList.toggle('active');
            if (themeOptions.classList.contains('active')) {
                notificationSettingsMenu.classList.remove('active');
                roleOptions.classList.remove('active');
            }
        }

        function toggleNotificationSettings(e) {
            e.stopPropagation();
            e.preventDefault(); // A√±adimos esto para prevenir el comportamiento por defecto
            notificationSettingsMenu.classList.toggle('active');
            if (notificationSettingsMenu.classList.contains('active')) {
                themeOptions.classList.remove('active');
                roleOptions.classList.remove('active');
            }
        }

        function toggleRoleOptions(e) {
            e.stopPropagation();
            roleOptions.classList.toggle('active');
            if (roleOptions.classList.contains('active')) {
                themeOptions.classList.remove('active');
                notificationSettingsMenu.classList.remove('active');
            }
        }

        function mostrarLoginScreen() {
            loginScreen.style.display = 'flex';
            appContainer.style.display = 'none';
            authButtons.style.display = 'flex';
            document.body.classList.remove('logged-in'); // Asegura que la clase se remueva
            document.querySelector('.top-header').style.display = 'flex'; // Asegura que la cabecera sea visible
            appContainer.style.paddingTop = 'var(--header-height)'; // Restablece el padding
        }

        function mostrarLogoutDialog() {
            logoutDialog.classList.add('active');
        }

        function showConfirm(message, callback) {
            confirmMessage.textContent = message;
            confirmCallback = callback;
            confirmDialog.classList.add('active');
        }

        // Funci√≥n para iniciar sesi√≥n con Google
        function iniciarSesionGoogle() {
            auth.signInWithPopup(googleProvider)
                .then((result) => {
                    // Check if user data exists in Firestore
                    db.collection('usuarios').doc(result.user.uid).get().then(doc => {
                        if (!doc.exists) {
                            // New user, ask for full name and role
                            usuario = {
                                uid: result.user.uid,
                                email: result.user.email,
                                foto: result.user.photoURL || 'https://i.imgur.com/8Km9tLL.png'
                            };
                            roleSelectionModal.style.display = 'flex';
                        } else {
                            // Existing user, load data
                            const userData = doc.data();
                            userRole = userData.role;
                            userFullName = userData.fullName;
                            handleUserLogin(result.user);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error al iniciar sesi√≥n con Google:', error);
                });
        }

        function selectRole(role) {
            const fullName = fullNameInput.value.trim();
            if (!fullName) {
                mostrarError('full-name-input', 'error-full-name');
                return;
            }

            userRole = role;
            userFullName = fullName;
            roleSelectionModal.style.display = 'none';

            // Save user data to Firestore
            crearPerfilUsuario(usuario.uid, usuario.email, usuario.foto, userRole, userFullName);
            handleUserLogin(auth.currentUser); // Re-trigger login flow with full data
        }

        // Funci√≥n para usar sin autenticaci√≥n
        function usarLocalStorage() {
            usuario = {
                uid: 'local-user-' + Date.now(),
                nombre: "Usuario Local",
                email: "local@example.com",
                foto: "https://i.imgur.com/8Km9tLL.png",
                local: true
            };
            userRole = 'student'; // Default role for local user
            userFullName = "Usuario Local";
            
            localStorage.setItem('usuario', JSON.stringify(usuario));
            localStorage.setItem('userRole', userRole);
            localStorage.setItem('userFullName', userFullName);
            usandoFirebase = false;
            
            // Ocultar informaci√≥n de login
            loginInfo.style.display = 'none';
            
            // Mostrar la aplicaci√≥n
            loginScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            
            // Mostrar botones de autenticaci√≥n en el header
            authButtons.style.display = 'flex';
            document.body.classList.remove('logged-in'); // Asegura que la clase se remueva
            document.querySelector('.top-header').style.display = 'flex'; // Asegura que la cabecera sea visible
            appContainer.style.paddingTop = 'var(--header-height)'; // Restablece el padding
            
            // Cargar datos locales
            cargarDatosLocales();
            renderizarUIporRol();
            
            mostrarNotificacion('Modo local activado - Los datos no se sincronizar√°n');
        }

        // Funci√≥n para verificar la sesi√≥n al cargar
        function verificarSesion() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is logged in, fetch their role and full name
                    db.collection('usuarios').doc(user.uid).get().then(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            userRole = userData.role;
                            userFullName = userData.fullName;
                            handleUserLogin(user);
                        } else {
                            // User logged in but no profile data (should not happen if role selection worked)
                            // Fallback: ask for role and full name
                            usuario = {
                                uid: user.uid,
                                email: user.email,
                                foto: user.photoURL || 'https://i.imgur.com/8Km9tLL.png'
                            };
                            roleSelectionModal.style.display = 'flex';
                        }
                    }).catch(error => {
                        console.error("Error fetching user profile:", error);
                        handleUserLogout(); // Treat as logout on error
                    });
                } else {
                    // No user logged in
                    handleUserLogout();
                }
            });
        }

        function handleUserLogin(user) {
            usuario = {
                uid: user.uid,
                nombre: userFullName || user.displayName || user.email.split('@')[0],
                email: user.email,
                foto: user.photoURL || 'https://i.imgur.com/8Km9tLL.png'
            };
            
            document.body.classList.add('logged-in'); // A√±ade la clase al body
            document.querySelector('.top-header').style.display = 'none'; // Oculta la cabecera
            appContainer.style.paddingTop = '0'; // Ajusta el padding a 0
            
            // Mostrar informaci√≥n de usuario
            userAvatar.src = usuario.foto;
            userEmail.textContent = usuario.email;
            loginInfo.style.display = 'flex';
            
            // Ocultar botones de autenticaci√≥n en el header
            authButtons.style.display = 'none';
            
            // Guardar datos de sesi√≥n
            localStorage.setItem('usuario', JSON.stringify(usuario));
            localStorage.setItem('userRole', userRole);
            localStorage.setItem('userFullName', userFullName);
            usandoFirebase = true;
            
            // Cargar datos de Firestore
            cargarDatosFirebase();
            
            // Mostrar la aplicaci√≥n
            loginScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            renderizarUIporRol();

            // Check for pending group join
            handlePendingGroupJoinCode();
        }

        function handleUserLogout() {
            // Verificar si hay datos locales
            const usuarioLocal = JSON.parse(localStorage.getItem('usuario'));
            const localRole = localStorage.getItem('userRole');
            const localFullName = localStorage.getItem('userFullName');
            
            document.body.classList.remove('logged-in'); // Remueve la clase del body
            document.querySelector('.top-header').style.display = 'flex'; // Muestra la cabecera
            appContainer.style.paddingTop = 'var(--header-height)'; // Restablece el padding

            if (usuarioLocal && usuarioLocal.local) {
                // Usuario local
                usuario = usuarioLocal;
                userRole = localRole;
                userFullName = localFullName;
                usandoFirebase = false;
                loginInfo.style.display = 'none';
                authButtons.style.display = 'flex';
                cargarDatosLocales();
                loginScreen.style.display = 'none';
                appContainer.style.display = 'flex';
                renderizarUIporRol();
            } else {
                // No hay usuario local ni autenticado
                loginScreen.style.display = 'flex';
                appContainer.style.display = 'none';
                authButtons.style.display = 'flex';
                usuario = null;
                userRole = null;
                userFullName = null;
                // Clear all local storage related to user data
                localStorage.removeItem('usuario');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userFullName');
                localStorage.removeItem('materias');
                localStorage.removeItem('tareas');
                localStorage.removeItem('examenes');
                localStorage.removeItem('notes');
                localStorage.removeItem('groups');
                localStorage.removeItem('notificationSettings');
                localStorage.removeItem('theme');
            }
        }

        function crearPerfilUsuario(uid, email, photoURL, role, fullName) {
            db.collection('usuarios').doc(uid).set({
                fullName: fullName,
                email: email,
                photoURL: photoURL || '',
                role: role,
                fechaRegistro: firebase.firestore.FieldValue.serverTimestamp(),
                ultimoAcceso: firebase.firestore.FieldValue.serverTimestamp(),
                configuracion: {
                    tema: 'dark',
                    notificaciones: true
                }
            }).then(() => {
                console.log("Perfil de usuario creado/actualizado");
            }).catch((error) => {
                console.error("Error al crear/actualizar perfil:", error);
            });
        }

        function updateUserRole(uid, newRole) {
            db.collection('usuarios').doc(uid).update({
                role: newRole,
                ultimoAcceso: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                userRole = newRole;
                mostrarNotificacion(`Tu rol ha sido cambiado a ${newRole}`);
                renderizarUIporRol();
            }).catch(error => {
                console.error("Error updating user role:", error);
            });
        }

        // Funci√≥n para cerrar sesi√≥n
        function cerrarSesion() {
            auth.signOut().then(() => {
                // Limpiar solo la informaci√≥n de autenticaci√≥n, no los datos
                usuario = null;
                materiaSeleccionada = null;
                groupSeleccionado = null;
                
                logoutDialog.classList.remove('active');
                
                // Verificar si hay datos locales
                handleUserLogout();
                
                mostrarNotificacion('Sesi√≥n cerrada correctamente');
            }).catch(error => {
                console.error('Error al cerrar sesi√≥n:', error);
            });
        }

        async function eliminarCuenta() {
            deleteAccountDialog.classList.remove('active');
            if (!usuario || !usuario.uid) {
                mostrarNotificacion('No hay usuario para eliminar.');
                return;
            }

            try {
                // 1. Eliminar datos del usuario en Firestore
                const userDocRef = db.collection('usuarios').doc(usuario.uid);
                const collectionsToDelete = ['materias', 'tareas', 'examenes', 'notes'];

                for (const collectionName of collectionsToDelete) {
                    const snapshot = await userDocRef.collection(collectionName).get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }
                await userDocRef.delete();

                // 2. Eliminar archivos del Storage (opcional, si hay muchos archivos, puede ser lento)
                const storageRef = storage.ref(`notes/${usuario.uid}`);
                const listResult = await storageRef.listAll();
                for (const item of listResult.items) {
                    await item.delete();
                }
                // No se puede eliminar el prefijo del usuario directamente, solo los archivos dentro.

                // 3. Eliminar al usuario de los grupos donde sea miembro
                const groupsSnapshot = await db.collection('groups').where('members', 'array-contains', usuario.uid).get();
                for (const groupDoc of groupsSnapshot.docs) {
                    const groupData = groupDoc.data();
                    if (groupData.ownerId === usuario.uid) {
                        // If the user is the owner, delete the entire group
                        await db.collection('groups').doc(groupDoc.id).delete();
                    } else {
                        // If not the owner, just remove the user from members
                        await db.collection('groups').doc(groupDoc.id).update({
                            members: firebase.firestore.FieldValue.arrayRemove(usuario.uid)
                        });
                    }
                }

                // 4. Eliminar la cuenta de autenticaci√≥n
                await auth.currentUser.delete();

                mostrarNotificacion('Tu cuenta y todos tus datos han sido eliminados.');
                handleUserLogout(); // Reset UI after deletion
            } catch (error) {
                console.error('Error al eliminar la cuenta:', error);
                if (error.code === 'auth/requires-recent-login') {
                    mostrarNotificacion('Por favor, vuelve a iniciar sesi√≥n para eliminar tu cuenta por seguridad.');
                    await auth.signOut(); // Force re-login
                    handleUserLogout();
                } else {
                }
            }
        }

        function cargarDatosFirebase() {
            if (!usuario || !usuario.uid) return;
            
            // Materias (personalizadas para cada usuario)
            db.collection('usuarios').doc(usuario.uid).collection('materias')
                .onSnapshot(snapshot => {
                    materias = [];
                    snapshot.forEach(doc => {
                        materias.push({ id: doc.id, ...doc.data() });
                    });
                    renderizarMaterias();
                    guardarDatosLocales(); // Guardar cach√© local
                }, error => {
                    console.error('Error al cargar materias:', error);
                    cargarDatosLocales();
                });

            // Tareas (personalizadas para cada usuario)
            db.collection('usuarios').doc(usuario.uid).collection('tareas')
                .onSnapshot(snapshot => {
                    tareas = [];
                    snapshot.forEach(doc => {
                        tareas.push({ id: doc.id, ...doc.data() });
                    });
                    renderizarTareasPendientes();
                    renderizarTareasCompletadas();
                    guardarDatosLocales();
                    verificarRecordatorios();
                }, error => {
                    console.error('Error al cargar tareas:', error);
                    cargarDatosLocales();
                });

            // Ex√°menes (personalizadas para cada usuario)
            db.collection('usuarios').doc(usuario.uid).collection('examenes')
                .onSnapshot(snapshot => {
                    examenes = [];
                    snapshot.forEach(doc => {
                        examenes.push({ id: doc.id, ...doc.data() });
                    });
                    renderizarExamenesPendientes();
                    renderizarExamenesCompletados();
                    guardarDatosLocales();
                    verificarRecordatorios();
                }, error => {
                    console.error('Error al cargar ex√°menes:', error);
                    cargarDatosLocales();
                });

            // Notas (personalizadas para cada usuario)
            db.collection('usuarios').doc(usuario.uid).collection('notes')
                .onSnapshot(snapshot => {
                    notes = [];
                    snapshot.forEach(doc => {
                        notes.push({ id: doc.id, ...doc.data() });
                    });
                    renderizarNotas();
                    guardarDatosLocales();
                }, error => {
                    console.error('Error al cargar notas:', error);
                    cargarDatosLocales();
                });

            // Grupos (para maestros y alumnos)
            db.collection('groups')
                .where('members', 'array-contains', usuario.uid)
                .onSnapshot(snapshot => {
                    groups = [];
                    snapshot.forEach(doc => {
                        // Ensure we include all fields including code
                        const groupData = doc.data();
                        groups.push({ 
                            id: doc.id,
                            name: groupData.name, 
                            description: groupData.description,
                            code: groupData.code,
                            ownerId: groupData.ownerId,
                            members: groupData.members || []
                        });
                    });
                    renderizarGrupos();
                    guardarDatosLocales();
                }, error => {
                    console.error('Error al cargar grupos:', error);
                    cargarDatosLocales();
                });
        }

        function cargarDatosLocales() {
            const materiasLocal = localStorage.getItem('materias');
            if (materiasLocal) {
                materias = JSON.parse(materiasLocal);
                renderizarMaterias();
            }

            const tareasLocal = localStorage.getItem('tareas');
            if (tareasLocal) {
                tareas = JSON.parse(tareasLocal);
                renderizarTareasPendientes();
                renderizarTareasCompletadas();
            }

            const examenesLocal = localStorage.getItem('examenes');
            if (examenesLocal) {
                examenes = JSON.parse(examenesLocal);
                renderizarExamenesPendientes();
                renderizarExamenesCompletados();
            }

            const notesLocal = localStorage.getItem('notes');
            if (notesLocal) {
                notes = JSON.parse(notesLocal);
                renderizarNotas();
            }

            const groupsLocal = localStorage.getItem('groups');
            if (groupsLocal) {
                groups = JSON.parse(groupsLocal);
                renderizarGrupos();
            }

            verificarRecordatorios();
        }

        async function guardarDatos() {
            if (usandoFirebase && usuario && usuario.uid) {
                const batch = db.batch();

                // Materias
                materias.forEach(materia => {
                    const docRef = db.collection('usuarios').doc(usuario.uid).collection('materias').doc(materia.id);
                    batch.set(docRef, materia, { merge: true });
                });
                // Tareas
                tareas.forEach(tarea => {
                    const docRef = db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(tarea.id);
                    batch.set(docRef, tarea, { merge: true });
                });
                // Ex√°menes
                examenes.forEach(examen => {
                    const docRef = db.collection('usuarios').doc(usuario.uid).collection('examenes').doc(examen.id);
                    batch.set(docRef, examen, { merge: true });
                });
                // Notas
                notes.forEach(note => {
                    const docRef = db.collection('usuarios').doc(usuario.uid).collection('notes').doc(note.id);
                    batch.set(docRef, note, { merge: true });
                });
                // Groups are handled separately as they are shared collections

                try {
                    await batch.commit();
                    console.log("Datos guardados en Firebase.");
                } catch (error) {
                    console.error("Error al guardar datos en Firebase:", error);
                }
            }
            guardarDatosLocales();
        }

        function guardarDatosLocales() {
            localStorage.setItem('materias', JSON.stringify(materias));
            localStorage.setItem('tareas', JSON.stringify(tareas));
            localStorage.setItem('examenes', JSON.stringify(examenes));
            localStorage.setItem('notes', JSON.stringify(notes));
            localStorage.setItem('groups', JSON.stringify(groups));
        }

        function configurarServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registrado con √©xito');
                }).catch(err => {
                    console.log('Error al registrar ServiceWorker:', err);
                });
            }
        }

        function verificarRecordatorios() {
            const hoy = new Date().toISOString().split('T')[0];
            
            // Verificar tareas normales seg√∫n configuraci√≥n
            if (notificationSettings.normal.days > 0 || notificationSettings.normal.hours > 0) {
                const tareasNormales = tareas.filter(t => {
                    if (t.completada) return false; // No notificar tareas completadas
                    if (t.prioridad === 'alta') return false; // Las de alta prioridad se manejan aparte
                    
                    const fechaEntrega = new Date(t.fechaEntrega);
                    const hoyDate = new Date(hoy);
                    hoyDate.setHours(0, 0, 0, 0); // Normalizar a inicio del d√≠a
                    fechaEntrega.setHours(0, 0, 0, 0); // Normalizar a inicio del d√≠a

                    const diffTime = fechaEntrega.getTime() - hoyDate.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Diferencia en d√≠as

                    // Calcular la fecha de notificaci√≥n
                    const notifDate = new Date(fechaEntrega);
                    notifDate.setDate(notifDate.getDate() - notificationSettings.normal.days);
                    notifDate.setHours(notificationSettings.normal.hours, 0, 0, 0);

                    // Si la fecha de notificaci√≥n es hoy o ya pas√≥, y no se ha notificado antes
                    return notifDate.toDateString() === hoyDate.toDateString() && !notificaciones.includes(t.id);
                });
                
                tareasNormales.forEach(tarea => {
                    const mensaje = `Tarea pendiente para ${notificationSettings.normal.days} d√≠a(s) y ${notificationSettings.normal.hours} hora(s): ${tarea.descripcion} (${tarea.materia || 'Grupo'})`;
                    mostrarNotificacion(mensaje);
                    enviarNotificacionPush(mensaje);
                    notificaciones.push(tarea.id); // Marcar como notificada
                });
            }
            
            // Verificar tareas de alta prioridad seg√∫n configuraci√≥n
            if (notificationSettings.high.days > 0 || notificationSettings.high.hours > 0) {
                const tareasAltaPrioridad = tareas.filter(t => {
                    if (t.completada) return false;
                    if (t.prioridad !== 'alta') return false;
                    
                    const fechaEntrega = new Date(t.fechaEntrega);
                    const hoyDate = new Date(hoy);
                    hoyDate.setHours(0, 0, 0, 0);
                    fechaEntrega.setHours(0, 0, 0, 0);

                    const diffTime = fechaEntrega.getTime() - hoyDate.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    const notifDate = new Date(fechaEntrega);
                    notifDate.setDate(notifDate.getDate() - notificationSettings.high.days);
                    notifDate.setHours(notificationSettings.high.hours, 0, 0, 0);

                    return notifDate.toDateString() === hoyDate.toDateString() && !notificaciones.includes(t.id);
                });
                
                tareasAltaPrioridad.forEach(tarea => {
                    const mensaje = `RECUERDA: Tarea de alta prioridad para ${notificationSettings.high.days} d√≠a(s) y ${notificationSettings.high.hours} hora(s) (${tarea.materia || 'Grupo'})`;
                    mostrarNotificacion(mensaje);
                    enviarNotificacionPush(mensaje);
                    notificaciones.push(tarea.id);
                });
            }
            
            // Verificar ex√°menes seg√∫n configuraci√≥n
            if (notificationSettings.exam.days > 0 || notificationSettings.exam.hours > 0) {
                const examenesProximos = examenes.filter(e => {
                    if (e.completado) return false;
                    
                    const fechaExamen = new Date(e.fecha);
                    const hoyDate = new Date(hoy);
                    hoyDate.setHours(0, 0, 0, 0);
                    fechaExamen.setHours(0, 0, 0, 0);

                    const diffTime = fechaExamen.getTime() - hoyDate.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    const notifDate = new Date(fechaExamen);
                    notifDate.setDate(notifDate.getDate() - notificationSettings.exam.days);
                    notifDate.setHours(notificationSettings.exam.hours, 0, 0, 0);

                    return notifDate.toDateString() === hoyDate.toDateString() && !notificaciones.includes(e.id);
                });
                
                examenesProximos.forEach(examen => {
                    const mensaje = `EXAMEN PR√ìXIMO en ${notificationSettings.exam.days} d√≠a(s) y ${notificationSettings.exam.hours} hora(s): ${examen.descripcion} (${examen.materia || 'Grupo'}). √ötiles: ${examen.utiles || 'Ninguno especificado'}`;
                    mostrarNotificacion(mensaje);
                    enviarNotificacionPush(mensaje);
                    notificaciones.push(examen.id);
                });
            }
            
            // Guardar notificaciones mostradas
            localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
        }

        function enviarNotificacionPush(mensaje) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Recordatorio', { body: mensaje });
            }
        }

        function toggleSidebar() {
            if (sidebar) sidebar.classList.toggle('active');
        }

        function abrirModal(id) {
            // Limpiar errores
            document.querySelectorAll(`#${id} .error-message`).forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll(`#${id} .form-control`).forEach(el => {
                el.classList.remove('error');
            });
            
            document.getElementById(id).classList.add('active');
        }

        function cerrarModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function mostrarError(campoId, mensajeId) {
            document.getElementById(campoId).classList.add('error');
            document.getElementById(mensajeId).style.display = 'block';
            
            // Animaci√≥n de vibraci√≥n
            document.getElementById(campoId).style.animation = 'none';
            void document.getElementById(campoId).offsetWidth; // Trigger reflow
            document.getElementById(campoId).style.animation = 'vibrate 0.5s';
        }

        function validarFormulario(modalId) {
            let valido = true;
            const modal = document.getElementById(modalId);
            
            // Validar campos obligatorios
            modal.querySelectorAll('[required]').forEach(input => {
                if (!input.value.trim()) {
                    const errorId = `error-${input.id}`;
                    mostrarError(input.id, errorId);
                    valido = false;
                } else {
                    // Clear error if valid
                    const errorId = `error-${input.id}`;
                    document.getElementById(input.id).classList.remove('error');
                    document.getElementById(errorId).style.display = 'none';
                }
            });
            
            return valido;
        }

        async function guardarMateria() {
            if (!validarFormulario('modal-materia')) return;
            
            const nombreMateria = document.getElementById('nombre-materia').value.trim();
            const zonaMateria = parseInt(document.getElementById('zona-materia').value) || 0;

            const mode = document.getElementById('modal-materia').dataset.mode;

            if (mode === 'add') {
                if (materias.some(m => m.nombre === nombreMateria)) {
                    mostrarError('nombre-materia', 'error-nombre-materia');
                    document.getElementById('error-nombre-materia').textContent = 'Esta materia ya existe';
                    document.getElementById('error-nombre-materia').style.display = 'block';
                    return;
                }

                const nuevaMateria = {
                    id: usandoFirebase ? db.collection('usuarios').doc(usuario.uid).collection('materias').doc().id : 'local-' + Date.now(),
                    nombre: nombreMateria,
                    zona: zonaMateria,
                    ownerId: usuario.uid // Materias are personal
                };
                
                materias.push(nuevaMateria);
                cerrarModal('modal-materia'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    await db.collection('usuarios').doc(usuario.uid).collection('materias').doc(nuevaMateria.id).set(nuevaMateria);
                }
                mostrarNotificacion(`Materia "${nombreMateria}" agregada`);
            } else if (mode === 'edit') {
                const materiaId = document.getElementById('modal-materia').dataset.materiaId;
                const materiaToEdit = materias.find(m => m.id === materiaId);
                if (materiaToEdit) {
                    materiaToEdit.nombre = nombreMateria;
                    materiaToEdit.zona = zonaMateria;
                    cerrarModal('modal-materia'); // CERRAR MODAL INMEDIATAMENTE
                    if (usandoFirebase) {
                        await db.collection('usuarios').doc(usuario.uid).collection('materias').doc(materiaToEdit.id).update(materiaToEdit);
                    }
                    mostrarNotificacion(`Materia "${nombreMateria}" actualizada`);
                }
            }
            
            guardarDatosLocales(); // Update local storage immediately
            renderizarMaterias();
            
            // Limpiar formulario
            document.getElementById('nombre-materia').value = '';
            document.getElementById('zona-materia').value = '';
            
            // cerrarModal('modal-materia'); // MOVIDO ARRIBA
        }

        function editarMateria(id) {
            const materiaToEdit = materias.find(m => m.id === id);
            if (!materiaToEdit) return;

            document.getElementById('modal-materia').dataset.mode = 'edit';
            document.getElementById('modal-materia').dataset.materiaId = id;
            document.getElementById('modal-materia').querySelector('.modal-title').textContent = 'Editar Materia';
            document.getElementById('nombre-materia').value = materiaToEdit.nombre;
            document.getElementById('zona-materia').value = materiaToEdit.zona;
            abrirModal('modal-materia');
        }

        function eliminarMateria(id) {
            showConfirm('¬øEliminar esta materia y todas sus tareas y ex√°menes asociados?', async () => {
                const materia = materias.find(m => m.id === id);
                if (!materia) return;
                
                const nombreMateria = materia.nombre;

                if (usandoFirebase) {
                    const batch = db.batch();
                    const userTasksRef = db.collection('usuarios').doc(usuario.uid).collection('tareas');
                    const userExamsRef = db.collection('usuarios').doc(usuario.uid).collection('examenes');
                    const userNotesRef = db.collection('usuarios').doc(usuario.uid).collection('notes');

                    // Delete associated tasks
                    const tasksToDelete = tareas.filter(t => t.materia === nombreMateria);
                    for (const t of tasksToDelete) {
                        batch.delete(userTasksRef.doc(t.id));
                    }

                    // Delete associated exams
                    const examsToDelete = examenes.filter(e => e.materia === nombreMateria);
                    for (const e of examsToDelete) {
                        batch.delete(userExamsRef.doc(e.id));
                    }

                    // Delete associated notes and their files
                    const notesToDelete = notes.filter(n => n.materia === nombreMateria);
                    for (const n of notesToDelete) {
                        batch.delete(userNotesRef.doc(n.id));
                        if (n.attachments && n.attachments.length > 0) {
                            for (const attachment of n.attachments) {
                                try {
                                    const fileRef = storage.refFromURL(attachment.url);
                                    await fileRef.delete();
                                } catch (error) {
                                    console.warn(`Error al eliminar archivo ${attachment.name} del storage:`, error);
                                }
                            }
                        }
                    }

                    // Delete the materia itself
                    batch.delete(db.collection('usuarios').doc(usuario.uid).collection('materias').doc(id));

                    try {
                        await batch.commit();
                        console.log("Materia y elementos asociados eliminados de Firebase.");
                    } catch (error) {
                        console.error("Error al eliminar materia y elementos asociados en Firebase:", error);
                        return; // Stop if Firebase deletion fails
                    }
                }
                
                // Update local arrays
                tareas = tareas.filter(t => t.materia !== nombreMateria);
                examenes = examenes.filter(e => e.materia !== nombreMateria);
                notes = notes.filter(n => n.materia !== nombreMateria);
                materias = materias.filter(m => m.id !== id);
                
                if (materiaSeleccionada && materiaSeleccionada.id === id) {
                    materiaSeleccionada = null;
                    tituloTareas.textContent = 'Tareas Pendientes';
                    fixedButtonsContainer.style.display = 'none';
                    tareasPendientesContainer.style.display = 'none';
                    examenesPendientesContainer.style.display = 'none';
                    notesContainer.style.display = 'none';
                    tareasCompletadasContainer.style.display = 'none';
                    examenesCompletadosContainer.style.display = 'none';
                }
                
                guardarDatosLocales(); // Update local storage
                renderizarMaterias();
                renderizarTareasPendientes();
                renderizarExamenesPendientes();
                renderizarNotas();
                renderizarTareasCompletadas();
                renderizarExamenesCompletados();
                mostrarNotificacion('Materia eliminada');
            });
        }

        function eliminarTarea(id) {
            showConfirm('¬øEliminar esta tarea permanentemente?', async () => {
                if (usandoFirebase) {
                    await db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(id).delete();
                }
                tareas = tareas.filter(t => t.id !== id);
                guardarDatosLocales();
                renderizarTareasPendientes();
                renderizarTareasCompletadas();
                renderizarMaterias();
                mostrarNotificacion('Tarea eliminada');
            });
        }

        function eliminarExamen(id) {
            showConfirm('¬øEliminar este examen permanentemente?', async () => {
                if (usandoFirebase) {
                    await db.collection('usuarios').doc(usuario.uid).collection('examenes').doc(id).delete();
                }
                examenes = examenes.filter(e => e.id !== id);
                guardarDatosLocales();
                renderizarExamenesPendientes();
                renderizarExamenesCompletados();
                renderizarMaterias();
                mostrarNotificacion('Examen eliminado');
            });
        }

        function eliminarNota(id) {
            showConfirm('¬øEliminar esta nota permanentemente?', async () => {
                const noteToDelete = notes.find(n => n.id === id);
                if (noteToDelete && noteToDelete.attachments && noteToDelete.attachments.length > 0) {
                    // Delete files from storage
                    for (const attachment of noteToDelete.attachments) {
                        try {
                            // Ensure the path is correct for deletion
                            const fileRef = storage.refFromURL(attachment.url);
                            await fileRef.delete();
                            console.log(`Archivo ${attachment.name} eliminado del storage.`);
                        } catch (error) {
                            console.warn(`Error al eliminar archivo ${attachment.name} del storage:`, error);
                        }
                    }
                }

                if (usandoFirebase) {
                    await db.collection('usuarios').doc(usuario.uid).collection('notes').doc(id).delete();
                }
                notes = notes.filter(n => n.id !== id);
                guardarDatosLocales();
                renderizarNotas();
                mostrarNotificacion('Nota eliminada');
            });
        }

        function seleccionarMateria(materia) {
            materiaSeleccionada = materia;
            groupSeleccionado = null; // Deselect group
            
            // Actualizar UI
            document.querySelectorAll('.materia-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id == materia.id) {
                    item.classList.add('active');
                }
            });
            document.querySelectorAll('.group-item').forEach(item => item.classList.remove('active')); // Deselect group UI

            // Mostrar contenido de la materia seleccionada
            tituloTareas.textContent = `Tareas de ${materia.nombre}`;
            fixedButtonsContainer.style.display = 'flex';
            
            renderizarTareasPendientes();
            renderizarExamenesPendientes();
            renderizarNotas();
            renderizarTareasCompletadas();
            renderizarExamenesCompletados();

            // Hide group members section and group code display
            groupDetailsSection.style.display = 'none';
            teacherGroupCodeDisplay.style.display = 'none';

            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        async function seleccionarGrupo(group) {
            materiaSeleccionada = null; // Deselect materia
            groupSeleccionado = group;
            
            // Actualizar UI
            renderizarMaterias(); // Deseleccionar visualmente cualquier materia activa
            renderizarGrupos(); // Asegurar que el grupo seleccionado se marque como activo

            // Mostrar contenido del grupo seleccionado
            tituloTareas.textContent = `Contenido del Grupo: ${group.name}`;
            fixedButtonsContainer.style.display = 'flex';

            // Render group-specific tasks, exams, notes (if any)
            renderizarTareasPendientes();
            renderizarExamenesPendientes();
            renderizarNotas();
            renderizarTareasCompletadas();
            renderizarExamenesCompletados();

            // Render group members
            groupDetailsSection.style.display = 'block';
            await renderGroupMembers(group.id, groupMembersList);
            
            // Show group code for teachers only
            if (userRole === 'teacher') {
                teacherGroupCodeDisplay.style.display = 'flex';
                document.getElementById('generated-group-code-display').textContent = group.code; // Display the code
            } else {
                teacherGroupCodeDisplay.style.display = 'none'; // Hide for students
            }

            if (window.innerWidth <= 768) {
                toggleSidebar(); // Ocultar la barra lateral en m√≥vil
            }
        }

        async function renderGroupMembers(groupId, listElement) {
            listElement.innerHTML = '';
            const groupDoc = await db.collection('groups').doc(groupId).get();
            if (!groupDoc.exists) return;

            const members = groupDoc.data().members || [];
            if (members.length === 0) {
                listElement.innerHTML = '<p>No hay miembros en este grupo.</p>';
                return;
            }

            // Fetch all member details in parallel
            const memberPromises = members.map(memberId => db.collection('usuarios').doc(memberId).get());
            const memberDocs = await Promise.all(memberPromises);

            memberDocs.forEach(userDoc => {
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                    memberItem.innerHTML = `
                        <div class="member-info">
                            <div class="member-name">${userData.fullName}</div>
                            <div class="member-email">${userData.email} (${userData.role === 'teacher' ? 'Maestro' : 'Alumno'})</div>
                        </div>
                        ${userRole === 'teacher' && userDoc.id !== groupDoc.data().ownerId ? `<div class="member-actions"><button class="member-btn remove" data-member-id="${userDoc.id}"><i class="fas fa-user-minus"></i></button></div>` : ''}
                    `;
                    listElement.appendChild(memberItem);

                    if (userRole === 'teacher' && userDoc.id !== groupDoc.data().ownerId) {
                        memberItem.querySelector('.member-btn.remove').addEventListener('click', () => removeGroupMember(groupId, userDoc.id, userData.fullName));
                    }
                }
            });
        }

        async function removeGroupMember(groupId, memberId, memberName) {
            showConfirm(`¬øEst√°s seguro de que quieres eliminar a ${memberName} de este grupo?`, async () => {
                if (usandoFirebase) {
                    await db.collection('groups').doc(groupId).update({
                        members: firebase.firestore.FieldValue.arrayRemove(memberId)
                    });
                    mostrarNotificacion(`${memberName} ha sido eliminado del grupo.`);
                    renderGroupMembers(groupId, groupMembersList); // Re-render members list
                }
            });
        }

        function renderizarMaterias() {
            materiasList.innerHTML = '';
            
            if (materias.length === 0) {
                materiasList.innerHTML = '<p>No hay materias registradas</p>';
                return;
            }
            
            materias.forEach(materia => {
                const materiaElement = document.createElement('div');
                materiaElement.className = 'materia-item';
                if (materiaSeleccionada && materiaSeleccionada.id === materia.id) {
                    materiaElement.classList.add('active');
                }
                materiaElement.dataset.id = materia.id;
                
                const materiaContent = document.createElement('div');
                materiaContent.innerHTML = `
                    <div>${materia.nombre}</div>
                    <div class="materia-info">
                        Entregados: ${tareas
                            .filter(t => t.materia === materia.nombre && t.completada && t.entregada)
                            .reduce((sum, t) => sum + t.puntos, 0)}/${materia.zona}
                    </div>
                `;
                
                const materiaActions = document.createElement('div');
                materiaActions.className = 'materia-actions';
                materiaActions.innerHTML = `
                    <button class="materia-btn editar" onclick="app.editarMateria('${materia.id}')"><i class="fas fa-edit"></i></button>
                    <button class="materia-btn eliminar" onclick="app.eliminarMateria('${materia.id}')"><i class="fas fa-trash-alt"></i></button>
                `;
                
                materiaElement.appendChild(materiaContent);
                materiaElement.appendChild(materiaActions);
                
                materiaElement.addEventListener('click', (e) => {
                    // Evitar que el clic en los botones de acci√≥n active la selecci√≥n
                    if (!e.target.closest('.materia-actions')) {
                        seleccionarMateria(materia);
                    }
                });
                
                materiasList.appendChild(materiaElement);
            });
        }

        function renderizarGrupos() {
            groupsList.innerHTML = '';
            
            if (groups.length === 0) {
                groupsList.innerHTML = '<p>No hay grupos registrados</p>';
                return;
            }
            
            const uniqueGroups = [];
            const seenIds = new Set();
            
            for (const group of groups) {
                if (!seenIds.has(group.id)) {
                    seenIds.add(group.id);
                    uniqueGroups.push(group);
                }
            }
            joinGroupCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    joinGroupBtn.click();
                }
            });
            
            uniqueGroups.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'group-item';
                if (groupSeleccionado && groupSeleccionado.id === group.id) {
                    groupElement.classList.add('active');
                }
                groupElement.dataset.id = group.id;
                
                const groupContent = document.createElement('div');
                groupContent.innerHTML = `
                    <div>${group.name}</div>
                    <div class="group-info">${group.description || 'Sin descripci√≥n'}</div>
                `;
                
                const groupActions = document.createElement('div');
                groupActions.className = 'group-actions';
                if (userRole === 'teacher' && group.ownerId === usuario.uid) {
                    groupActions.innerHTML = `
                        <button class="group-btn editar" onclick="app.editarGrupo('${group.id}')"><i class="fas fa-edit"></i></button>
                        <button class="group-btn eliminar" onclick="app.eliminarGrupo('${group.id}')"><i class="fas fa-trash-alt"></i></button>
                    `;
                } else {
                    groupActions.innerHTML = `
                        <button class="group-btn eliminar" onclick="app.leaveGroup('${group.id}')"><i class="fas fa-sign-out-alt"></i></button>
                    `;
                }
                
                groupElement.appendChild(groupContent);
                groupElement.appendChild(groupActions);
                
                groupElement.addEventListener('click', (e) => {
                    if (!e.target.closest('.group-actions')) {
                        seleccionarGrupo(group);
                    }
                });
                
                groupsList.appendChild(groupElement);
            });
        }

        function renderizarTareasPendientes() {
            listaTareasPendientes.innerHTML = '';
            
            let filteredTareas = [];
            if (materiaSeleccionada) {
                filteredTareas = tareas.filter(t => t.materia === materiaSeleccionada.nombre && !t.completada);
            } else if (groupSeleccionado) {
                filteredTareas = tareas.filter(t => t.groupId === groupSeleccionado.id && !t.completada);
            } else {
                tareasPendientesContainer.style.display = 'none';
                return;
            }
            
            if (filteredTareas.length === 0) {
                tareasPendientesContainer.style.display = 'none';
                return;
            }
            
            tareasPendientesContainer.style.display = 'block';
            
            filteredTareas.forEach(tarea => {
                const tareaItem = document.createElement('div');
                tareaItem.className = 'tarea-item';
                
                // L√≥gica para permitir a maestros entregar tareas en sus propias materias y en grupos
                // y a estudiantes en sus propias materias
                const canComplete = (userRole === 'student' && materiaSeleccionada && !tarea.groupId) || // Alumno en materia personal
                                   (userRole === 'teacher' && (materiaSeleccionada && !tarea.groupId || groupSeleccionado && tarea.groupId)); // Maestro en materia personal o grupo

                tareaItem.innerHTML = `
                    <div class="tarea-info">
                        <div class="tarea-title">
                            <span class="tarea-prioridad ${tarea.prioridad === 'alta' ? 'prioridad-alta' : 'prioridad-normal'}"></span>
                            ${tarea.descripcion}
                            <span class="tarea-puntos">${tarea.puntos} pts</span>
                        </div>
                        <div class="tarea-descripcion">${tarea.materia || (groupSeleccionado ? groupSeleccionado.name : '')}</div>
                        <div class="tarea-fecha">Entrega: ${tarea.fechaEntrega}</div>
                    </div>
                    <div class="tarea-actions">
                        ${canComplete ? `
                            <button class="tarea-btn completar" data-id="${tarea.id}" title="Marcar como entregada">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        <button class="tarea-btn editar" data-id="${tarea.id}" title="Editar tarea">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="tarea-btn eliminar" data-id="${tarea.id}" title="Eliminar tarea">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                // Agregar eventos a los botones
                if (canComplete) {
                    const completarBtn = tareaItem.querySelector('.tarea-btn.completar');
                    if (completarBtn) {
                        completarBtn.addEventListener('click', () => completarTarea(tarea.id, true));
                    }
                }
                tareaItem.querySelector('.tarea-btn.editar').addEventListener('click', () => editarTarea(tarea.id));
                tareaItem.querySelector('.tarea-btn.eliminar').addEventListener('click', () => {
                    eliminarTarea(tarea.id);
                });
                
                listaTareasPendientes.appendChild(tareaItem);
            });
        }
        function renderizarExamenesPendientes() {
            listaExamenesPendientes.innerHTML = '';
            
            let filteredExams = [];
            if (materiaSeleccionada) {
                filteredExams = examenes.filter(e => e.materia === materiaSeleccionada.nombre && !e.completado);
            } else if (groupSeleccionado) {
                filteredExams = examenes.filter(e => e.groupId === groupSeleccionado.id && !e.completado);
            } else {
                examenesPendientesContainer.style.display = 'none';
                return;
            }
            
            if (filteredExams.length === 0) {
                examenesPendientesContainer.style.display = 'none';
                return;
            }
            
            examenesPendientesContainer.style.display = 'block';
            
            filteredExams.forEach(examen => {
                const examenItem = document.createElement('div');
                examenItem.className = 'tarea-item';
                
                // L√≥gica para permitir a maestros entregar ex√°menes en sus propias materias y en grupos
                // y a estudiantes en sus propias materias
                const canComplete = (userRole === 'student' && materiaSeleccionada && !examen.groupId) || // Alumno en materia personal
                                   (userRole === 'teacher' && (materiaSeleccionada && !examen.groupId || groupSeleccionado && examen.groupId)); // Maestro en materia personal o grupo

                examenItem.innerHTML = `
                    <div class="tarea-info">
                        <div class="tarea-title">
                            <span class="tarea-prioridad prioridad-alta"></span>
                            ${examen.descripcion}
                            <span class="tarea-puntos">${examen.puntos} pts</span>
                        </div>
                        <div class="tarea-descripcion">${examen.materia || (groupSeleccionado ? groupSeleccionado.name : '')}</div>
                        <div class="tarea-fecha">Fecha: ${examen.fecha}</div>
                        ${examen.utiles ? `<div class="tarea-descripcion">√ötiles: ${examen.utiles}</div>` : ''}
                    </div>
                    <div class="tarea-actions"> 
                        ${canComplete ? `<button class="tarea-btn completar" data-id="${examen.id}" title="Marcar como realizado"><i class="fas fa-check"></i></button>` : ''}
                        <button class="tarea-btn editar" data-id="${examen.id}" title="Editar examen"><i class="fas fa-edit"></i></button>
                        <button class="tarea-btn eliminar" data-id="${examen.id}" title="Eliminar examen"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                
                // Agregar eventos a los botones
                if (canComplete) {
                    const completarBtn = examenItem.querySelector('.tarea-btn.completar');
                    if (completarBtn) {
                        completarBtn.addEventListener('click', () => completarExamen(examen.id, true));
                    }
                }
                examenItem.querySelector('.tarea-btn.editar').addEventListener('click', () => editarExamen(examen.id));
                examenItem.querySelector('.tarea-btn.eliminar').addEventListener('click', () => {
                    eliminarExamen(examen.id);
                });
                
                listaExamenesPendientes.appendChild(examenItem);
            });
        }

        function renderizarNotas() {
            listaNotas.innerHTML = '';

            let filteredNotes = [];
            if (materiaSeleccionada) {
                filteredNotes = notes.filter(n => n.materia === materiaSeleccionada.nombre);
            } else if (groupSeleccionado) {
                filteredNotes = notes.filter(n => n.groupId === groupSeleccionado.id);
            } else {
                notesContainer.style.display = 'none';
                return;
            }

            if (filteredNotes.length === 0) {
                notesContainer.style.display = 'none';
                return;
            }

            notesContainer.style.display = 'block';

            filteredNotes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.className = 'note-item';

                let attachmentsHtml = '';
                if (note.attachments && note.attachments.length > 0) {
                    attachmentsHtml = '<div class="note-attachments">';
                    note.attachments.forEach(file => {
                        attachmentsHtml += `<a href="${file.url}" target="_blank"><i class="fas fa-file"></i> ${file.name}</a>`;
                    });
                    attachmentsHtml += '</div>';
                }

                noteItem.innerHTML = `
                    <div class="note-info">
                        <div class="note-title">${note.title}</div>
                        <div class="note-content">${note.content || ''}</div>
                        ${attachmentsHtml}
                        <div class="note-date">Creada: ${new Date(note.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div class="note-actions">
                        <button class="note-btn editar" data-id="${note.id}" title="Editar nota"><i class="fas fa-edit"></i></button>
                        <button class="note-btn eliminar" data-id="${note.id}" title="Eliminar nota"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;

                noteItem.querySelector('.note-btn.editar').addEventListener('click', () => editarNota(note.id));
                noteItem.querySelector('.note-btn.eliminar').addEventListener('click', () => {
                    eliminarNota(note.id); // Direct call to eliminate
                });

                listaNotas.appendChild(noteItem);
            });
        }

        function renderizarTareasCompletadas() {
            listaTareasCompletadas.innerHTML = '';
            
            let filteredTareas = [];
            if (materiaSeleccionada) {
                filteredTareas = tareas.filter(t => t.materia === materiaSeleccionada.nombre && t.completada);
            } else if (groupSeleccionado) {
                filteredTareas = tareas.filter(t => t.groupId === groupSeleccionado.id && t.completada);
            } else {
                tareasCompletadasContainer.style.display = 'none';
                return;
            }
            
            if (filteredTareas.length === 0) {
                tareasCompletadasContainer.style.display = 'none';
                return;
            }
            
            tareasCompletadasContainer.style.display = 'block';
            
            filteredTareas.forEach(tarea => {
                const tareaItem = document.createElement('div');
                tareaItem.className = `tarea-completada ${tarea.entregada ? 'entregada' : 'no-entregada'}`;
                
                tareaItem.innerHTML = `
                    <div class="tarea-completada-info">
                        <div>${tarea.descripcion}</div>
                        <div class="tarea-fecha">Entrega: ${tarea.fechaEntrega}</div>
                    </div>
                    <div>
                        <span class="tarea-completada-status ${tarea.entregada ? 'entregada-text' : 'no-entregada-text'}">
                            ${tarea.entregada ? 'Entregada' : 'No entregada'}
                        </span>
                        <span class="tarea-puntos">${tarea.puntos} pts</span>
                        <button class="tarea-btn eliminar" data-id="${tarea.id}" title="Eliminar tarea">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                // Agregar evento al bot√≥n de eliminar
                tareaItem.querySelector('.tarea-btn.eliminar').addEventListener('click', () => {
                    eliminarTarea(tarea.id); // Direct call to eliminate
                });
                
                listaTareasCompletadas.appendChild(tareaItem);
            });
        }

        function renderizarExamenesCompletados() {
            listaExamenesCompletados.innerHTML = '';
            
            let filteredExams = [];
            if (materiaSeleccionada) {
                filteredExams = examenes.filter(e => e.materia === materiaSeleccionada.nombre && e.completado);
            } else if (groupSeleccionado) {
                filteredExams = examenes.filter(e => e.groupId === groupSeleccionado.id && e.completado);
            } else {
                examenesCompletadosContainer.style.display = 'none';
                return;
            }
            
            if (filteredExams.length === 0) {
                examenesCompletadosContainer.style.display = 'none';
                return;
            }
            
            examenesCompletadosContainer.style.display = 'block';
            
            filteredExams.forEach(examen => {
                const examenItem = document.createElement('div');
                examenItem.className = `tarea-completada ${examen.realizado ? 'entregada' : 'no-entregada'}`;
                
                examenItem.innerHTML = `
                    <div class="tarea-completada-info">
                        <div>${examen.descripcion}</div>
                        <div class="tarea-fecha">Fecha: ${examen.fecha}</div>
                    </div>
                    <div>
                        <span class="tarea-completada-status ${examen.realizado ? 'entregada-text' : 'no-entregada-text'}">
                            ${examen.realizado ? 'Realizado' : 'No realizado'}
                        </span>
                        <span class="tarea-puntos">${examen.puntos} pts</span>
                        <button class="tarea-btn eliminar" data-id="${examen.id}" title="Eliminar examen">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                // Agregar evento al bot√≥n de eliminar
                examenItem.querySelector('.tarea-btn.eliminar').addEventListener('click', () => {
                    eliminarExamen(examen.id); // Direct call to eliminate
                });
                
                listaExamenesCompletados.appendChild(examenItem);
            });
        }

        function editarTarea(id) {
            tareaEditando = tareas.find(t => t.id === id);
            if (!tareaEditando) return;
            
            document.getElementById('modal-tarea-title').textContent = 'Editar Tarea';
            document.getElementById('tarea-descripcion').value = tareaEditando.descripcion;
            document.getElementById('tarea-puntos').value = tareaEditando.puntos;
            document.getElementById('tarea-fecha').value = tareaEditando.fechaEntrega;
            document.getElementById('tarea-prioridad').checked = tareaEditando.prioridad === 'alta';
            
            document.getElementById('tarea-status-group').style.display = 'block';
            document.querySelector(`input[name="tarea-status"]:checked`).checked = false; // Deseleccionar el actual
            document.querySelector(`input[name="tarea-status"][value="${tareaEditando.entregada ? 'entregada' : 'no-entregada'}"]`).checked = true;
            
            document.getElementById('cancelar-tarea').style.display = 'block';
            abrirModal('modal-tarea');
        }

        async function guardarTarea() {
            if (!validarFormulario('modal-tarea')) return;
            
            const descripcion = document.getElementById('tarea-descripcion').value.trim();
            const puntos = parseInt(document.getElementById('tarea-puntos').value) || 0;
            const fechaEntrega = document.getElementById('tarea-fecha').value;
            const prioridad = document.getElementById('tarea-prioridad').checked ? 'alta' : 'normal';
            const entregada = tareaEditando ? 
                document.querySelector('input[name="tarea-status"]:checked').value === 'entregada' : true;
                // Validar puntos m√°ximos
            if (materiaSeleccionada) {
                const materia = materias.find(m => m.id === materiaSeleccionada.id);
                if (puntos > materia.zona) {
                    mostrarNotificacion(`Los puntos no pueden ser mayores que la zona de la materia (${materia.zona})`);
                    return;
                }
            }

            if (tareaEditando) {
                // Editar tarea existente
                tareaEditando.descripcion = descripcion;
                tareaEditando.puntos = puntos;
                tareaEditando.fechaEntrega = fechaEntrega;
                tareaEditando.prioridad = prioridad;
                tareaEditando.entregada = entregada;
                
                cerrarModal('modal-tarea'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    await db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(tareaEditando.id).update(tareaEditando);
                }
                mostrarNotificacion('Tarea actualizada');
            } else {
                // Nueva tarea
                const nuevaTarea = {
                    id: usandoFirebase ? db.collection('usuarios').doc(usuario.uid).collection('tareas').doc().id : 'local-' + Date.now(),
                    materia: materiaSeleccionada ? materiaSeleccionada.nombre : null,
                    groupId: groupSeleccionado ? groupSeleccionado.id : null,
                    descripcion,
                    puntos,
                    fechaEntrega,
                    prioridad,
                    completada: false,
                    entregada: true,
                    tipo: 'tarea',
                    createdAt: Date.now()
                };
                tareas.push(nuevaTarea);
                
                cerrarModal('modal-tarea'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    await db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(nuevaTarea.id).set(nuevaTarea);
                }
                mostrarNotificacion('Tarea agregada');
                
                // Programar recordatorios
                programarRecordatoriosTarea(nuevaTarea);
            }
            
            guardarDatosLocales();
            renderizarTareasPendientes();
            renderizarTareasCompletadas();
            renderizarMaterias();
            // cerrarModal('modal-tarea'); // MOVIDO ARRIBA
        }

        function programarRecordatoriosTarea(tarea) {
            const fechaEntrega = new Date(tarea.fechaEntrega);
            const hoy = new Date();
            
            // Diferencia en horas
            const diffTime = fechaEntrega - hoy;
            const diffHours = Math.ceil(diffTime / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            const remainingHours = diffHours % 24;
            
            // Programar notificaciones seg√∫n prioridad
            if (tarea.prioridad === 'alta' && 
                (notificationSettings.high.days > 0 || notificationSettings.high.hours > 0)) {
                
                const targetDays = notificationSettings.high.days;
                const targetHours = notificationSettings.high.hours;
                
                if ((diffDays > targetDays) || 
                    (diffDays === targetDays && remainingHours >= targetHours)) {
                    
                    const notificacionFecha = new Date(fechaEntrega);
                    notificacionFecha.setDate(notificacionFecha.getDate() - targetDays);
                    notificacionFecha.setHours(notificacionFecha.getHours() - targetHours);
                    
                    // En una implementaci√≥n real usar√≠as el API de notificaciones push
                    console.log(`Recordatorio programado para ${notificacionFecha.toISOString()}: Tarea de alta prioridad "${tarea.descripcion}"`);
                }
            } else if (notificationSettings.normal.days > 0 || notificationSettings.normal.hours > 0) {
                const targetDays = notificationSettings.normal.days;
                const targetHours = notificationSettings.normal.hours;
                
                if ((diffDays > targetDays) || 
                    (diffDays === targetDays && remainingHours >= targetHours)) {
                    
                    const notificacionFecha = new Date(fechaEntrega);
                    notificacionFecha.setDate(notificacionFecha.getDate() - targetDays);
                    notificacionFecha.setHours(notificacionFecha.getHours() - targetHours);
                    
                    console.log(`Recordatorio programado para ${notificacionFecha.toISOString()}: Tarea "${tarea.descripcion}"`);
                }
            }
        }

        async function cancelarTarea() {
            showConfirm('¬øCancelar esta tarea?', async () => {
                tareaEditando.completada = true;
                tareaEditando.entregada = false;
                
                if (usandoFirebase) {
                    await db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(tareaEditando.id).update(tareaEditando);
                }
                guardarDatosLocales();
                renderizarTareasPendientes();
                renderizarTareasCompletadas();
                renderizarMaterias();
                cerrarModal('modal-tarea');
                
                mostrarNotificacion('Tarea cancelada');
            });
        }

        async function completarTarea(id, entregada) {
            const tarea = tareas.find(t => t.id === id);
            if (!tarea) return;
            
            tarea.completada = true;
            tarea.entregada = entregada;
            
            if (usandoFirebase) {
                await db.collection('usuarios').doc(usuario.uid).collection('tareas').doc(tarea.id).update(tarea);
            }

            if (entregada) {
                mostrarNotificacion(`Tarea entregada: +${tarea.puntos} puntos`);
            } else {
                mostrarNotificacion('Tarea marcada como no entregada');
            }
            
            guardarDatosLocales();
            
            // Animaci√≥n de desaparici√≥n
            const tareaElement = document.querySelector(`.tarea-item button.completar[data-id="${id}"]`)?.closest('.tarea-item');
            if (tareaElement) {
                tareaElement.classList.add('fade-out');
                
                setTimeout(() => {
                    renderizarTareasPendientes();
                    renderizarTareasCompletadas();
                    renderizarMaterias();
                }, 300);
            } else {
                renderizarTareasPendientes();
                renderizarTareasCompletadas();
                renderizarMaterias();
            }
        }

        function editarExamen(id) {
            examenEditando = examenes.find(e => e.id === id);
            if (!examenEditando) return;
            
            document.getElementById('modal-examen-title').textContent = 'Editar Examen';
            document.getElementById('examen-descripcion').value = examenEditando.descripcion;
            document.getElementById('examen-puntos').value = examenEditando.puntos;
            document.getElementById('examen-fecha').value = examenEditando.fecha;
            document.getElementById('examen-utiles').value = examenEditando.utiles || '';
            
            document.getElementById('examen-status-group').style.display = 'block';
            document.querySelector(`input[name="examen-status"]:checked`).checked = false; // Deseleccionar el actual
            document.querySelector(`input[name="examen-status"][value="${examenEditando.realizado ? 'realizado' : 'no-realizado'}"]`).checked = true;
            
            abrirModal('modal-examen');
        }

        async function guardarExamen() {
            if (!validarFormulario('modal-examen')) return;
            
            const descripcion = document.getElementById('examen-descripcion').value.trim();
            const puntos = parseInt(document.getElementById('examen-puntos').value) || 0;
            const fecha = document.getElementById('examen-fecha').value;
            const utiles = document.getElementById('examen-utiles').value.trim();
            const realizado = examenEditando ? 
                document.querySelector('input[name="examen-status"]:checked').value === 'realizado' : false;

            if (examenEditando) {
                // Editar examen existente
                examenEditando.descripcion = descripcion;
                examenEditando.puntos = puntos;
                examenEditando.fecha = fecha;
                examenEditando.utiles = utiles;
                examenEditando.realizado = realizado;
                
                cerrarModal('modal-examen'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    await db.collection('usuarios').doc(usuario.uid).collection('examenes').doc(examenEditando.id).update(examenEditando);
                }
                mostrarNotificacion('Examen actualizado');
            } else {
                // Nuevo examen
                const nuevoExamen = {
                    id: usandoFirebase ? db.collection('usuarios').doc(usuario.uid).collection('examenes').doc().id : 'local-' + Date.now(),
                    materia: materiaSeleccionada ? materiaSeleccionada.nombre : null,
                    groupId: groupSeleccionado ? groupSeleccionado.id : null,
                    descripcion,
                    puntos,
                    fecha,
                    utiles,
                    completado: false,
                    realizado: false,
                    tipo: 'examen',
                    createdAt: Date.now()
                };
                examenes.push(nuevoExamen);
                
                cerrarModal('modal-examen'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    await db.collection('usuarios').doc(usuario.uid).collection('examenes').doc(nuevoExamen.id).set(nuevoExamen);
                }
                mostrarNotificacion('Examen agregado');
                
                // Programar recordatorios
                programarRecordatoriosExamen(nuevoExamen);
            }
            
            guardarDatosLocales();
            renderizarExamenesPendientes();
            renderizarExamenesCompletados();
            renderizarMaterias();
            // cerrarModal('modal-examen'); // MOVIDO ARRIBA
        }

        function programarRecordatoriosExamen(examen) {
            if (notificationSettings.exam.days <= 0 && notificationSettings.exam.hours <= 0) return;
            
            const fechaExamen = new Date(examen.fecha);
            const hoy = new Date();
            
            // Diferencia en horas
            const diffTime = fechaExamen - hoy;
            const diffHours = Math.ceil(diffTime / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            const remainingHours = diffHours % 24;
            
            const targetDays = notificationSettings.exam.days;
            const targetHours = notificationSettings.exam.hours;
            
            // Recordatorio seg√∫n configuraci√≥n
            if ((diffDays > targetDays) || 
                (diffDays === targetDays && remainingHours >= targetHours)) {
                
                const notificacionFecha = new Date(fechaExamen);
                notificacionFecha.setDate(notificacionFecha.getDate() - targetDays);
                notificacionFecha.setHours(notificacionFecha.getHours() - targetHours);
                
                // En una implementaci√≥n real usar√≠as el API de notificaciones push
                console.log(`Recordatorio programado para ${notificacionFecha.toISOString()}: Examen "${examen.descripcion}" - √ötiles: ${examen.utiles || 'Ninguno'}`);
            }
        }

        async function completarExamen(id, realizado) {
            const examen = examenes.find(e => e.id === id);
            if (!examen) return;
            
            examen.completado = true;
            examen.realizado = realizado;
            
            if (usandoFirebase) {
                await db.collection('usuarios').doc(usuario.uid).collection('examenes').doc(examen.id).update(examen);
            }

            if (realizado) {
                mostrarNotificacion(`Examen realizado: +${examen.puntos} puntos`);
            } else {
                mostrarNotificacion('Examen marcado como no realizado');
            }
            
            guardarDatosLocales();
            
            // Animaci√≥n de desaparici√≥n
            const examenElement = document.querySelector(`.tarea-item button.completar[data-id="${id}"]`)?.closest('.tarea-item');
            if (examenElement) {
                examenElement.classList.add('fade-out');
                
                setTimeout(() => {
                    renderizarExamenesPendientes();
                    renderizarExamenesCompletados();
                    renderizarMaterias();
                }, 300);
            } else {
                renderizarExamenesPendientes();
                renderizarExamenesCompletados();
                renderizarMaterias();
            }
        }

        function editarNota(id) {
            noteEditando = notes.find(n => n.id === id);
            if (!noteEditando) return;

            document.getElementById('modal-nota-title').textContent = 'Editar Nota';
            document.getElementById('nota-titulo').value = noteEditando.title;
            document.getElementById('nota-contenido').value = noteEditando.content || '';
            currentFiles = noteEditando.attachments || [];
            renderNoteFiles();
            uploadProgressContainer.style.display = 'none'; // Hide progress bar
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.textContent = '0%';
            abrirModal('modal-nota');
        }

        async function guardarNota() {
            if (!validarFormulario('modal-nota')) return;

            const title = document.getElementById('nota-titulo').value.trim();
            const content = document.getElementById('nota-contenido').value.trim();
            
            // Filter out files that are already uploaded (have a URL)
            const filesToUpload = currentFiles.filter(file => file instanceof File);
            const existingFiles = currentFiles.filter(file => !(file instanceof File));

            const uploadedFiles = [...existingFiles]; // Start with existing files

            if (filesToUpload.length > 0 && usandoFirebase) {
                uploadProgressContainer.style.display = 'block';
                uploadProgressBar.style.width = '0%';
                uploadProgressBar.textContent = '0%';
            }

            for (let i = 0; i < filesToUpload.length; i++) {
                const file = filesToUpload[i];
                const storageRef = storage.ref(`notes/${usuario.uid}/${Date.now()}-${file.name}`);
                const uploadTask = storageRef.put(file);

                try {
                    await new Promise((resolve, reject) => {
                        uploadTask.on('state_changed', 
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                uploadProgressBar.style.width = progress + '%';
                                uploadProgressBar.textContent = Math.round(progress) + '%';
                            }, 
                            (error) => {
                                console.error("Error uploading file:", file.name, error);
                                reject(error);
                            }, 
                            async () => {
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                uploadedFiles.push({ name: file.name, url: downloadURL, size: file.size, type: file.type });
                                resolve();
                            }
                        );
                    });
                } catch (error) {
                    uploadProgressContainer.style.display = 'none';
                    return; // Stop saving if upload fails
                }
            }
            uploadProgressContainer.style.display = 'none'; // Hide progress bar after all uploads

            if (noteEditando) {
                // Update existing note
                noteEditando.title = title;
                noteEditando.content = content;
                noteEditando.attachments = uploadedFiles;

                cerrarModal('modal-nota'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    await db.collection('usuarios').doc(usuario.uid).collection('notes').doc(noteEditando.id).update(noteEditando);
                }
                mostrarNotificacion('Nota actualizada');
            } else {
                // Create new note
                const newNote = {
                    id: usandoFirebase ? db.collection('usuarios').doc(usuario.uid).collection('notes').doc().id : 'local-' + Date.now(),
                    materia: materiaSeleccionada ? materiaSeleccionada.nombre : null,
                    groupId: groupSeleccionado ? groupSeleccionado.id : null,
                    title,
                    content,
                    attachments: uploadedFiles,
                    createdAt: Date.now(),
                    ownerId: usuario.uid // To track who created the note
                };
                notes.push(newNote);

                cerrarModal('modal-nota'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    await db.collection('usuarios').doc(usuario.uid).collection('notes').doc(newNote.id).set(newNote);
                }
                mostrarNotificacion('Nota agregada');
            }

            renderizarNotas();
            // cerrarModal('modal-nota'); // MOVIDO ARRIBA
        }
        

        async function handleNoteFileSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
             uploadProgressContainer.style.display = 'block';
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.textContent = '0%';

            for (const file of files) {
                try {
                    const storagePath = `notes/${usuario.uid}/${Date.now()}_${file.name}`;
                    const storageRef = storage.ref(storagePath);
                    const uploadTask = storageRef.put(file);

                    await new Promise((resolve, reject) => {
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                uploadProgressBar.style.width = progress + '%';
                                uploadProgressBar.textContent = Math.round(progress) + '%';
                            },
                            (error) => {
                                console.error("Error uploading file:", error);
                                reject(error);
                            },
                            async () => {
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                currentFiles.push({
                                    name: file.name,
                                    url: downloadURL,
                                    size: file.size,
                                    type: file.type
                                });
                                resolve();
                            }
                        );
                    });
                } catch (error) {
                    console.error("Error uploading file:", error);
                }
            }

            uploadProgressContainer.style.display = 'none';
            renderNoteFiles();
            event.target.value = '';
        }

        function handleNoteFileDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            notaFileUploadContainer.classList.remove('dragover');
            const files = Array.from(event.dataTransfer.files);
            addFilesToCurrent(files);
        }

        function addFilesToCurrent(files) {
            files.forEach(file => {
                // Prevent adding duplicate files by name
                if (!currentFiles.some(f => f.name === file.name)) {
                    currentFiles.push(file);
                }
            });
            renderNoteFiles();
        }

        function removeNoteFile(index) {
            currentFiles.splice(index, 1);
            renderNoteFiles();
        }

        function renderNoteFiles() {
            notaFileList.innerHTML = '';
            if (currentFiles.length === 0) {
                notaFileList.style.display = 'none';
                return;
            }
            notaFileList.style.display = 'block';
            currentFiles.forEach((file, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'file-list-item';
                const fileName = file.name || (file.url ? file.url.split('/').pop().split('?')[0] : 'Archivo desconocido');
                listItem.innerHTML = `
                    <span>${fileName}</span>
                    <button type="button" data-index="${index}"><i class="fas fa-times"></i></button>
                `;
                listItem.querySelector('button').addEventListener('click', () => removeNoteFile(index));
                notaFileList.appendChild(listItem);
            });
        }

        function generateUniqueCode(length = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+[]{}|;:,.<>?';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function guardarGrupo() {
            if (!validarFormulario('modal-group')) return;

            const groupName = document.getElementById('group-name').value.trim();
            const groupDescription = document.getElementById('group-description').value.trim();
            const mode = document.getElementById('modal-group').dataset.mode;


            if (mode === 'add') {
                const newGroupCode = generateUniqueCode(); // Generate unique code
                const groupId = usandoFirebase ? db.collection('groups').doc().id : 'local-' + Date.now(); 

                const newGroup = {
                    id: groupId,
                    name: groupName,
                    description: groupDescription,
                    code: newGroupCode, // Store the unique code
                    ownerId: usuario.uid,
                    ownerName: userFullName,
                    members: [usuario.uid],
                    createdAt: Date.now(),
                    materia: materiaSeleccionada ? materiaSeleccionada.nombre : null
                };

                cerrarModal('modal-group'); // CERRAR MODAL INMEDIATAMENTE
                if (usandoFirebase) {
                    try {
                        await db.collection('groups').doc(newGroup.id).set(newGroup);
                        groups.push(newGroup);
                        mostrarNotificacion(`Grupo "${groupName}" creado.`);
                        // Display the generated code
                        generatedGroupCode.textContent = newGroup.code;
                        document.getElementById('group-code-display').style.display = 'flex';
                        groupCodeInfoMessage.style.display = 'block';
                        renderizarGrupos();
                    } catch (error) {
                        console.error("Error al guardar grupo:", error);
                    }
                } else {
                    groups.push(newGroup);
                    mostrarNotificacion(`Grupo "${groupName}" creado.`);
                    generatedGroupCode.textContent = newGroup.code;
                    document.getElementById('group-code-display').style.display = 'flex';
                    groupCodeInfoMessage.style.display = 'block';
                    renderizarGrupos();
                }
            } else if (mode === 'edit') {
                const groupId = groupEditando.id;
                const groupToUpdate = groups.find(g => g.id === groupId);
                if (groupToUpdate) {
                    groupToUpdate.name = groupName;
                    groupToUpdate.description = groupDescription;
                    cerrarModal('modal-group'); // CERRAR MODAL INMEDIATAMENTE
                    if (usandoFirebase) {
                        await db.collection('groups').doc(groupId).update({
                            name: groupName,
                            description: groupDescription
                        });
                    }
                    mostrarNotificacion(`Grupo "${groupName}" actualizado.`);
                }
            }
            
            guardarDatosLocales(); // Update local storage
            // cerrarModal('modal-group'); // MOVIDO ARRIBA
        }

        function editarGrupo(id) {
            groupEditando = groups.find(g => g.id === id);
            if (!groupEditando) return;

            document.getElementById('modal-group').dataset.mode = 'edit';
            document.getElementById('modal-group-title').textContent = 'Editar Grupo';
            document.getElementById('group-name').value = groupEditando.name;
            document.getElementById('group-description').value = groupEditando.description || '';
            document.getElementById('group-code-display').style.display = 'none'; // Hide code display for editing
            groupCodeInfoMessage.style.display = 'none'; // Hide info message for editing
            abrirModal('modal-group');
        }

        function copyGroupCode() {
            const code = generatedGroupCode.textContent;
            navigator.clipboard.writeText(code).then(() => {
                mostrarNotificacion('C√≥digo de grupo copiado al portapapeles.');
            }).catch(err => {
                console.error('Error al copiar el c√≥digo:', err);
            });
        }

        async function copyCurrentGroupCode() {
            const code = groupSeleccionado.code; // Get code from selected group
            try {
                await navigator.clipboard.writeText(code);
                mostrarNotificacion('Cualquiera con este c√≥digo puede unirse a su grupo, incluidos los alumnos.');
            } catch (err) {
                console.error('Error al copiar el c√≥digo:', err);
                mostrarNotificacion('Error al copiar el c√≥digo.');
            }
        }

        async function joinGroup(groupCode) {
            let joinInput;
            if (typeof groupCode === 'string') {
                joinInput = groupCode;
            } else {
                joinInput = document.getElementById('join-group-code').value.trim();
            }

            if (!usuario || !usuario.uid) {
                mostrarNotificacion('Debes iniciar sesi√≥n para unirte a un grupo.');
                localStorage.setItem('pendingGroupJoinCode', joinInput);
                mostrarLoginScreen();
                return;
            }

            try {
                // Query groups by the unique code
                const groupsRef = db.collection('groups');
                const querySnapshot = await groupsRef.where('code', '==', joinInput).limit(1).get();

                if (querySnapshot.empty) {
                    mostrarNotificacion('Grupo no encontrado. Verifica el c√≥digo.');
                    return;
                }

                const groupDoc = querySnapshot.docs[0];
                const groupData = groupDoc.data();

                if (groupData.members.includes(usuario.uid)) {
                    mostrarNotificacion('Ya eres miembro de este grupo.');
                    document.getElementById('join-group-code').value = '';
                    seleccionarGrupo(groupData);
                    return;
                }

                // Add user to group members
                if (usandoFirebase) {
                    await db.collection('groups').doc(groupData.id).update({
                        members: firebase.firestore.FieldValue.arrayUnion(usuario.uid)
                    });
                }

                mostrarNotificacion(`Te has unido al grupo "${groupData.name}".`);
                document.getElementById('join-group-code').value = '';
                // Force data refresh and UI update
                await cargarDatosFirebase();
                seleccionarGrupo({...groupData, id: groupDoc.id}); 
                renderizarGrupos(); 
            } catch (error) {
                console.error('Error al unirse al grupo:', error);
                mostrarNotificacion('Error al unirse al grupo. Verifica el c√≥digo.');
            }
        }

        function eliminarGrupo(id) {
            showConfirm('¬øEst√°s seguro de que quieres eliminar este grupo? Esta acci√≥n es irreversible y eliminar√° el grupo para todos los miembros.', async () => {
                if (usandoFirebase) {
                    // Delete group from Firestore
                    await db.collection('groups').doc(id).delete();
                }
                groups = groups.filter(g => g.id !== id);
                if (groupSeleccionado && groupSeleccionado.id === id) {
                    groupSeleccionado = null;
                    tituloTareas.textContent = 'Tareas Pendientes';
                    fixedButtonsContainer.style.display = 'none';
                    tareasPendientesContainer.style.display = 'none';
                    examenesPendientesContainer.style.display = 'none';
                    notesContainer.style.display = 'none';
                    tareasCompletadasContainer.style.display = 'none';
                    examenesCompletadosContainer.style.display = 'none';
                    groupDetailsSection.style.display = 'none';
                    teacherGroupCodeDisplay.style.display = 'none';
                }
                guardarDatosLocales();
                renderizarGrupos();
                mostrarNotificacion('Grupo eliminado.');
            });
        }

        function leaveGroup(id) {
            showConfirm('¬øEst√°s seguro de que quieres salir de este grupo?', async () => {
                if (usandoFirebase) {
                    await db.collection('groups').doc(id).update({
                        members: firebase.firestore.FieldValue.arrayRemove(usuario.uid)
                    });
                }
                groups = groups.filter(g => g.id !== id);
                if (groupSeleccionado && groupSeleccionado.id === id) {
                    groupSeleccionado = null;
                    tituloTareas.textContent = 'Tareas Pendientes';
                    fixedButtonsContainer.style.display = 'none';
                    tareasPendientesContainer.style.display = 'none';
                    examenesPendientesContainer.style.display = 'none';
                    notesContainer.style.display = 'none';
                    tareasCompletadasContainer.style.display = 'none';
                    examenesCompletadosContainer.style.display = 'none';
                    groupDetailsSection.style.display = 'none';
                    teacherGroupCodeDisplay.style.display = 'none';
                }
                guardarDatosLocales();
                renderizarGrupos();
                mostrarNotificacion('Has salido del grupo.');
            });
        }

        function mostrarNotificacion(mensaje) {
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion';
            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.classList.add('fade-out');
                setTimeout(() => notificacion.remove(), 300);
            }, 4000); 
        }

        function verificarTareasVencidas() {
            const hoy = new Date();
            const tareasVencidas = tareas.filter(t => {
                if (t.completada) return false;
                
                const fechaEntrega = new Date(t.fechaEntrega);
                return fechaEntrega < hoy;
            });
            
            tareasVencidas.forEach(tarea => {
                mostrarNotificacion(`Tarea vencida: ${tarea.descripcion} (${tarea.materia || 'Grupo'})`);
            });
        }

       function renderizarUIporRol() {
            // La secci√≥n de grupos y unirse a grupos es visible para ambos roles
            // Solo el bot√≥n "Nuevo Grupo" es espec√≠fico de maestros
            if (userRole === 'teacher') {
                abrirModalGroupBtn.style.display = 'block';
                document.getElementById('sidebar-title-materias').textContent = 'Materias Personales';
            } else {
                abrirModalGroupBtn.style.display = 'none';
                document.getElementById('sidebar-title-materias').textContent = 'Mis Materias';
            }

            // Re-render lists to apply role-based permissions
            renderizarMaterias();
            renderizarGrupos();
            renderizarTareasPendientes();
            renderizarExamenesPendientes();
            renderizarNotas();
            renderizarTareasCompletadas();
            renderizarExamenesCompletados();
        }

        // Objeto global para acceder a las funciones desde HTML
        window.app = {
            eliminarMateria,
            editarMateria,
            completarTarea,
            editarTarea,
            eliminarTarea,
            completarExamen,
            editarExamen,
            eliminarExamen,
            editarNota,
            eliminarNota,
            editarGrupo,
            eliminarGrupo,
            leaveGroup
        };
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggle-members-btn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    const list = document.getElementById('group-members-list');
                    const arrow = document.getElementById('members-arrow');
                    if (list.style.display === 'none') {
                        list.style.display = 'block';
                        arrow.classList.remove('fa-chevron-down');
                        arrow.classList.add('fa-chevron-up');
                    } else {
                        list.style.display = 'none';
                        arrow.classList.remove('fa-chevron-up');
                        arrow.classList.add('fa-chevron-down');
                    }
                });
            }
        });
        document.addEventListener('click', function(e) {
            const isSettingsMenu = e.target.closest('.settings-menu');
            const isSubMenu = e.target.closest('.theme-options, .role-options, .notification-settings');
            
            if (!isSettingsMenu && !isSubMenu) {
                document.querySelectorAll('.theme-options, .role-options, .notification-settings').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        });
    </script>
</body>
</html>