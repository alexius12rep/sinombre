<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador Académico Inteligente</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --color-primary: #050916;
            --color-secondary: #0b5657;
            --color-accent: #0d3430;
            --color-light: #ffffff;
            --color-dark: #0080ff;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #032711;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            min-height: 100vh;
            color: var(--color-light);
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Menú lateral */
        .sidebar {
            width: 250px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            padding: 20px;
            transition: transform 0.3s;
            border-right: 1px solid rgba(36, 106, 104, 0.1);
            position: relative;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .sidebar-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
        }

        .materias-list {
            overflow-y: auto;
            max-height: calc(100vh - 220px);
        }

        .materia-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .materia-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .materia-item.active {
            background: var(--color-accent);
            font-weight: bold;
        }

        .materia-info {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .materia-actions {
            display: none;
        }

        .materia-item:hover .materia-actions {
            display: flex;
            gap: 5px;
        }

        .materia-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .materia-btn.eliminar {
            background: var(--color-danger);
        }

        .materia-btn.eliminar:hover {
            background: #c82333;
        }

        .add-materia-btn {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: var(--color-accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-materia-btn:hover {
            background: #002343;
        }

        /* Login info */
        .login-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .user-email {
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .logout-btn {
            background: none;
            border: none;
            color: rgb(219, 219, 219);
            cursor: pointer;
            margin-left: 10px;
        }

        /* Contenido principal */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
        }

        .app-title {
            font-size: 2rem;
            font-weight: bold;
        }

        /* Tareas */
        .tareas-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tarea-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            animation: fadeIn 0.5s ease-out;
        }

        .tarea-item:last-child {
            margin-bottom: 0;
        }

        .tarea-info {
            flex: 1;
        }

        .tarea-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .tarea-prioridad {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .prioridad-alta {
            background-color: #710101;
        }

        .prioridad-normal {
            background-color: #153704;
        }

        .tarea-descripcion {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .tarea-fecha {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .tarea-puntos {
            background: var(--color-accent);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .tarea-actions {
            display: flex;
            gap: 10px;
        }

        .tarea-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tarea-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tarea-btn.completar {
            background: var(--color-success);
        }

        .tarea-btn.completar:hover {
            background: #218838;
        }

        .tarea-btn.eliminar {
            background: var(--color-danger);
        }

        .tarea-btn.eliminar:hover {
            background: #ff6b81;
        }

        .tarea-btn.editar {
            background: var(--color-warning);
        }

        .tarea-btn.editar:hover {
            background: #e0a800;
        }

        /* Modales */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: linear-gradient(135deg, #485563, #29323c);
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .form-control.error {
            border-color: var(--color-danger);
            animation: vibrate 0.5s;
        }

        .error-message {
            color: var(--color-danger);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        .tipo-tarea {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tipo-tarea-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tipo-tarea-btn.active {
            background: var(--color-accent);
            font-weight: bold;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--color-accent);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #4f84ff;
            transform: translateY(-2px);
        }

        /* Sección de tareas completadas */
        .tareas-completadas-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .tarea-completada {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tarea-completada.entregada {
            background: rgba(40, 167, 69, 0.2);
            text-decoration: line-through;
        }

        .tarea-completada.no-entregada {
            background: rgba(220, 53, 69, 0.2);
            text-decoration: line-through;
        }

        .tarea-completada-info {
            flex: 1;
        }

        .tarea-completada-status {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .entregada-text {
            color: var(--color-success);
        }

        .no-entregada-text {
            color: var(--color-danger);
        }

        /* Login */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
        }

        .login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        .login-btn img {
            width: 20px;
            height: 20px;
        }

        .login-optional {
            margin-top: 20px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Notificaciones */
        .notificacion {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1001;
            animation: fadeIn 0.3s ease-out;
        }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }

        @keyframes vibrate {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 100;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .close-sidebar {
                display: block;
            }

            .menu-btn {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h1 class="login-title">Organizador Académico</h1>
            <p>Inicia sesión para sincronizar tus dispositivos</p>
            <button id="google-login" class="login-btn">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google">
                Continuar con Google
            </button>
            <div class="login-optional">
                <button id="skip-login" style="background: none; border: none; color: var(--color-light); text-decoration: underline; cursor: pointer;">
                    O continuar sin iniciar sesión
                </button>
            </div>
        </div>
    </div>

    <div id="app-container" class="app-container" style="display: none;">
        <!-- Menú lateral -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Materias</div>
                <button class="close-sidebar" id="close-sidebar">×</button>
            </div>
            <div class="materias-list" id="materias-list"></div>
            <button class="add-materia-btn" id="abrir-modal-materia">+ Nueva Materia</button>
            
            <!-- Información de login -->
            <div class="login-info" id="login-info" style="display: none;">
                <img id="user-avatar" class="user-avatar" src="" alt="Foto de perfil">
                <div id="user-email" class="user-email"></div>
                <button class="logout-btn" id="logout-btn" title="Cerrar sesión">✕</button>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="main-content">
            <div class="header">
                <button class="menu-btn" id="menu-btn">☰</button>
                <h1 class="app-title">Organizador Académico</h1>
            </div>

            <!-- Tareas pendientes -->
            <div class="tareas-container" id="tareas-pendientes-container" style="display: none;">
                <h2 class="section-title" id="titulo-tareas">Tareas Pendientes</h2>
                <div id="lista-tareas-pendientes"></div>
            </div>

            <!-- Exámenes pendientes -->
            <div class="tareas-container" id="examenes-pendientes-container" style="display: none;">
                <h2 class="section-title">Exámenes Pendientes</h2>
                <div id="lista-examenes-pendientes"></div>
            </div>

            <button class="add-materia-btn" id="abrir-modal-tarea" style="display: none; margin-top: 20px;">+ Nueva Tarea</button>
            <button class="add-materia-btn" id="abrir-modal-examen" style="display: none; margin-top: 10px; background: var(--color-info);">+ Nuevo Examen</button>

            <!-- Tareas completadas -->
            <div class="tareas-completadas-container" id="tareas-completadas-container" style="display: none;">
                <h2 class="section-title">Tareas Completadas</h2>
                <div id="lista-tareas-completadas"></div>
            </div>

            <!-- Exámenes completados -->
            <div class="tareas-completadas-container" id="examenes-completados-container" style="display: none;">
                <h2 class="section-title">Exámenes Realizados</h2>
                <div id="lista-examenes-completados"></div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar materia -->
    <div class="modal" id="modal-materia">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Nueva Materia</h2>
                <button class="close-modal" id="cerrar-modal-materia">×</button>
            </div>
            <div class="form-group">
                <label for="nombre-materia">Nombre de la materia</label>
                <input type="text" id="nombre-materia" class="form-control" placeholder="Ej: Matemáticas" required>
                <div class="error-message" id="error-nombre-materia">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="zona-materia">Puntos de zona</label>
                <input type="number" id="zona-materia" class="form-control" placeholder="Ej: 40" min="1" required>
                <div class="error-message" id="error-zona-materia">Este campo es obligatorio</div>
            </div>
            <button class="btn btn-primary" id="guardar-materia">Guardar</button>
        </div>
    </div>

    <!-- Modal para agregar/editar tarea -->
    <div class="modal" id="modal-tarea">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-tarea-title">Nueva Tarea</h2>
                <button class="close-modal" id="cerrar-modal-tarea">×</button>
            </div>
            <div class="form-group">
                <label for="tarea-descripcion">Descripción</label>
                <input type="text" id="tarea-descripcion" class="form-control" placeholder="Ej: Hacer ejercicios de álgebra" required>
                <div class="error-message" id="error-tarea-descripcion">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="tarea-puntos">Puntos</label>
                <input type="number" id="tarea-puntos" class="form-control" placeholder="Ej: 10" min="1" required>
                <div class="error-message" id="error-tarea-puntos">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="tarea-fecha">Fecha de entrega</label>
                <input type="date" id="tarea-fecha" class="form-control" required>
                <div class="error-message" id="error-tarea-fecha">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="tarea-prioridad"> Prioridad alta
                </label>
            </div>
            <div class="form-group" id="tarea-status-group" style="display: none;">
                <label>Estado</label>
                <div>
                    <label>
                        <input type="radio" name="tarea-status" value="entregada" checked> Entregada
                    </label>
                    <label>
                        <input type="radio" name="tarea-status" value="no-entregada"> No entregada
                    </label>
                </div>
            </div>
            <button class="btn btn-primary" id="guardar-tarea">Guardar</button>
            <button class="btn btn-primary" id="cancelar-tarea" style="background: var(--color-danger); margin-top: 10px; display: none;">Cancelar Tarea</button>
        </div>
    </div>

    <!-- Modal para agregar/editar examen -->
    <div class="modal" id="modal-examen">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-examen-title">Nuevo Examen</h2>
                <button class="close-modal" id="cerrar-modal-examen">×</button>
            </div>
            <div class="form-group">
                <label for="examen-descripcion">Descripción</label>
                <input type="text" id="examen-descripcion" class="form-control" placeholder="Ej: Examen parcial de álgebra" required>
                <div class="error-message" id="error-examen-descripcion">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="examen-puntos">Puntos</label>
                <input type="number" id="examen-puntos" class="form-control" placeholder="Ej: 30" min="1" required>
                <div class="error-message" id="error-examen-puntos">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="examen-fecha">Fecha del examen</label>
                <input type="date" id="examen-fecha" class="form-control" required>
                <div class="error-message" id="error-examen-fecha">Este campo es obligatorio</div>
            </div>
            <div class="form-group">
                <label for="examen-utiles">Útiles necesarios</label>
                <input type="text" id="examen-utiles" class="form-control" placeholder="Ej: Calculadora, cuaderno, libro">
            </div>
            <div class="form-group" id="examen-status-group" style="display: none;">
                <label>Estado</label>
                <div>
                    <label>
                        <input type="radio" name="examen-status" value="realizado" checked> Realizado
                    </label>
                    <label>
                        <input type="radio" name="examen-status" value="no-realizado"> No realizado
                    </label>
                </div>
            </div>
            <button class="btn btn-primary" id="guardar-examen">Guardar</button>
        </div>
    </div>

    <script>
        // Configuración de Firebase (reemplaza con tus credenciales)
        const firebaseConfig = {
            apiKey: "AIzaSyDEXAMPLEEXAMPLEEXAMPLE",
            authDomain: "tu-proyecto.firebaseapp.com",
            projectId: "tu-proyecto",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abc123EXAMPLE"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variables globales
        let materias = [];
        let tareas = [];
        let examenes = [];
        let materiaSeleccionada = null;
        let tareaEditando = null;
        let examenEditando = null;
        let usuario = null;
        let notificaciones = [];
        let usandoFirebase = false;

        // Elementos del DOM
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const googleLoginBtn = document.getElementById('google-login');
        const skipLoginBtn = document.getElementById('skip-login');
        const loginInfo = document.getElementById('login-info');
        const userAvatar = document.getElementById('user-avatar');
        const userEmail = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const closeSidebar = document.getElementById('close-sidebar');
        const materiasList = document.getElementById('materias-list');
        
        const tareasPendientesContainer = document.getElementById('tareas-pendientes-container');
        const listaTareasPendientes = document.getElementById('lista-tareas-pendientes');
        const examenesPendientesContainer = document.getElementById('examenes-pendientes-container');
        const listaExamenesPendientes = document.getElementById('lista-examenes-pendientes');
        const tareasCompletadasContainer = document.getElementById('tareas-completadas-container');
        const listaTareasCompletadas = document.getElementById('lista-tareas-completadas');
        const examenesCompletadosContainer = document.getElementById('examenes-completados-container');
        const listaExamenesCompletados = document.getElementById('lista-examenes-completados');
        
        const tituloTareas = document.getElementById('titulo-tareas');
        const btnNuevaTarea = document.getElementById('abrir-modal-tarea');
        const btnNuevoExamen = document.getElementById('abrir-modal-examen');

        // Modales
        const modalMateria = document.getElementById('modal-materia');
        const modalTarea = document.getElementById('modal-tarea');
        const modalExamen = document.getElementById('modal-examen');
        
        // Eventos
        menuBtn.addEventListener('click', toggleSidebar);
        closeSidebar.addEventListener('click', toggleSidebar);
        googleLoginBtn.addEventListener('click', iniciarSesionGoogle);
        skipLoginBtn.addEventListener('click', usarLocalStorage);
        logoutBtn.addEventListener('click', cerrarSesion);

        // Inicializar
document.addEventListener('DOMContentLoaded', () => {
    verificarSesion(); // Asegúrate que sea "Sesion" (sin la 's' extra)
    configurarServiceWorker();
    verificarRecordatorios();
    inicializarApp();
    
    // Intervalo seguro (solo si no existe)
    if (!window.intervaloVerificacion) {
        window.intervaloVerificacion = setInterval(() => {
            if (tareas.length > 0) { // Solo verificar si hay datos
                verificarTareasVencidas();
            }
        }, 24 * 60 * 60 * 1000);
    }
});
        // Funciones
        function verificarSesion() {
            // Verificar si hay un usuario autenticado
            auth.onAuthStateChanged(user => {
                if (user) {
                    // Usuario inició sesión con Google
                    usuario = {
                        uid: user.uid,
                        nombre: user.displayName,
                        email: user.email,
                        foto: user.photoURL
                    };
                    
                    localStorage.setItem('usuario', JSON.stringify(usuario));
                    usandoFirebase = true;
                    
                    // Mostrar información de usuario
                    userAvatar.src = usuario.foto;
                    userEmail.textContent = usuario.email;
                    loginInfo.style.display = 'flex';
                    
                    // Cargar datos de Firestore
                    cargarDatosFirebase();
                    
                    loginScreen.style.display = 'none';
                    appContainer.style.display = 'flex';
                } else {
                    // Verificar si hay datos locales
                    const usuarioLocal = JSON.parse(localStorage.getItem('usuario'));
                    if (usuarioLocal && usuarioLocal.email) {
                        // Usuario prefirió no iniciar sesión pero ya tiene datos
                        usuario = usuarioLocal;
                        usandoFirebase = false;
                        
                        // Ocultar información de login
                        loginInfo.style.display = 'none';
                        
                        // Cargar datos locales
                        cargarDatosLocales();
                        
                        loginScreen.style.display = 'none';
                        appContainer.style.display = 'flex';
                    } else {
                        // Mostrar pantalla de login
                        loginScreen.style.display = 'flex';
                        appContainer.style.display = 'none';
                    }
                }
            });
        }

        function iniciarSesionGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            auth.signInWithPopup(provider).then(result => {
                // La autenticación se maneja en onAuthStateChanged
                mostrarNotificacion(`Bienvenido ${result.user.displayName}`);
            }).catch(error => {
                console.error('Error al iniciar sesión:', error);
                mostrarNotificacion('Error al iniciar sesión con Google');
            });
        }

        function usarLocalStorage() {
            usuario = {
                nombre: "Usuario Local",
                email: "local@example.com",
                local: true
            };
            
            localStorage.setItem('usuario', JSON.stringify(usuario));
            usandoFirebase = false;
            
            // Ocultar información de login
            loginInfo.style.display = 'none';
            
            // Cargar datos locales
            cargarDatosLocales();
            
            loginScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            
            mostrarNotificacion('Modo local activado - Los datos no se sincronizarán');
        }

        function cerrarSesion() {
            auth.signOut().then(() => {
                localStorage.removeItem('usuario');
                localStorage.removeItem('materias');
                localStorage.removeItem('tareas');
                localStorage.removeItem('examenes');
                
                usuario = null;
                materias = [];
                tareas = [];
                examenes = [];
                materiaSeleccionada = null;
                
                loginScreen.style.display = 'flex';
                appContainer.style.display = 'none';
                
                mostrarNotificacion('Sesión cerrada correctamente');
            }).catch(error => {
                console.error('Error al cerrar sesión:', error);
            });
        }

        function cargarDatosFirebase() {
            if (!usuario || !usuario.uid) return;
            
            // Cargar materias
            db.collection('usuarios').doc(usuario.uid).collection('materias').get()
                .then(snapshot => {
                    materias = [];
                    snapshot.forEach(doc => {
                        materias.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Cargar tareas
                    return db.collection('usuarios').doc(usuario.uid).collection('tareas').get();
                })
                .then(snapshot => {
                    tareas = [];
                    snapshot.forEach(doc => {
                        tareas.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Cargar exámenes
                    return db.collection('usuarios').doc(usuario.uid).collection('examenes').get();
                })
                .then(snapshot => {
                    examenes = [];
                    snapshot.forEach(doc => {
                        examenes.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Renderizar datos
                    renderizarMaterias();
                    verificarRecordatorios();
                })
                .catch(error => {
                    console.error('Error al cargar datos:', error);
                    mostrarNotificacion('Error al cargar datos. Usando datos locales');
                    
                    // Intentar cargar datos locales como respaldo
                    cargarDatosLocales();
                });
        }

        function cargarDatosLocales() {
            materias = JSON.parse(localStorage.getItem('materias')) || [];
            tareas = JSON.parse(localStorage.getItem('tareas')) || [];
            examenes = JSON.parse(localStorage.getItem('examenes')) || [];
            
            renderizarMaterias();
            verificarRecordatorios();
        }

        function guardarDatos() {
            if (usandoFirebase && usuario && usuario.uid) {
                // Guardar en Firebase
                const batch = db.batch();
                const userRef = db.collection('usuarios').doc(usuario.uid);
                
                // Limpiar datos anteriores (en una implementación real usarías actualizaciones incrementales)
                batch.set(userRef, { lastUpdate: firebase.firestore.FieldValue.serverTimestamp() });
                
                // Guardar materias
                materias.forEach(materia => {
                    const materiaRef = userRef.collection('materias').doc(materia.id);
                    batch.set(materiaRef, {
                        nombre: materia.nombre,
                        zona: materia.zona
                    });
                });
                
                // Guardar tareas
                tareas.forEach(tarea => {
                    const tareaRef = userRef.collection('tareas').doc(tarea.id);
                    batch.set(tareaRef, {
                        materia: tarea.materia,
                        descripcion: tarea.descripcion,
                        puntos: tarea.puntos,
                        fechaEntrega: tarea.fechaEntrega,
                        prioridad: tarea.prioridad,
                        completada: tarea.completada,
                        entregada: tarea.entregada,
                        tipo: tarea.tipo
                    });
                });
                
                // Guardar exámenes
                examenes.forEach(examen => {
                    const examenRef = userRef.collection('examenes').doc(examen.id);
                    batch.set(examenRef, {
                        materia: examen.materia,
                        descripcion: examen.descripcion,
                        puntos: examen.puntos,
                        fecha: examen.fecha,
                        utiles: examen.utiles,
                        completado: examen.completado,
                        realizado: examen.realizado,
                        tipo: examen.tipo
                    });
                });
                
                batch.commit().then(() => {
                    console.log('Datos guardados en Firebase');
                }).catch(error => {
                    console.error('Error al guardar en Firebase:', error);
                    // Guardar localmente como respaldo
                    guardarDatosLocales();
                });
            } else {
                // Guardar localmente
                guardarDatosLocales();
            }
        }

        function guardarDatosLocales() {
            localStorage.setItem('materias', JSON.stringify(materias));
            localStorage.setItem('tareas', JSON.stringify(tareas));
            localStorage.setItem('examenes', JSON.stringify(examenes));
        }

        function configurarServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registrado con éxito');
                }).catch(err => {
                    console.log('Error al registrar ServiceWorker:', err);
                });
            }
        }

        function verificarRecordatorios() {
            const hoy = new Date().toISOString().split('T')[0];
            
            // Verificar tareas que vencen mañana
            const tareasManana = tareas.filter(t => {
                if (t.completada) return false;
                
                const fechaEntrega = new Date(t.fechaEntrega);
                const hoyDate = new Date(hoy);
                const diffTime = fechaEntrega - hoyDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                return diffDays === 1;
            });
            
            // Verificar exámenes en 2 días
            const examenesProximos = examenes.filter(e => {
                if (e.completado) return false;
                
                const fechaExamen = new Date(e.fecha);
                const hoyDate = new Date(hoy);
                const diffTime = fechaExamen - hoyDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                return diffDays === 2;
            });
            
            // Mostrar notificaciones
            tareasManana.forEach(tarea => {
                const mensaje = tarea.prioridad === 'alta' ? 
                    `RECUERDA: Tarea de alta prioridad para mañana (${tarea.materia})` : 
                    `Tarea pendiente para mañana: ${tarea.descripcion} (${tarea.materia})`;
                
                mostrarNotificacion(mensaje);
                enviarNotificacionPush(mensaje);
            });
            
            examenesProximos.forEach(examen => {
                const mensaje = `EXAMEN PRÓXIMO: ${examen.descripcion} (${examen.materia}) en 2 días. Útiles: ${examen.utiles || 'Ninguno especificado'}`;
                mostrarNotificacion(mensaje);
                enviarNotificacionPush(mensaje);
            });
            
            // Guardar notificaciones mostradas
            notificaciones = [...tareasManana.map(t => t.id), ...examenesProximos.map(e => e.id)];
            localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
        }

        function enviarNotificacionPush(mensaje) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Recordatorio', { body: mensaje });
            }
        }

        function inicializarApp() {
            // Configurar eventos
            document.getElementById('abrir-modal-materia').addEventListener('click', () => abrirModal('modal-materia'));
            document.getElementById('cerrar-modal-materia').addEventListener('click', () => cerrarModal('modal-materia'));
            document.getElementById('guardar-materia').addEventListener('click', guardarMateria);
            
            document.getElementById('abrir-modal-tarea').addEventListener('click', () => {
                tareaEditando = null;
                document.getElementById('modal-tarea-title').textContent = 'Nueva Tarea';
                document.getElementById('tarea-status-group').style.display = 'none';
                document.getElementById('cancelar-tarea').style.display = 'none';
                abrirModal('modal-tarea');
            });
            
            document.getElementById('cerrar-modal-tarea').addEventListener('click', () => cerrarModal('modal-tarea'));
            document.getElementById('guardar-tarea').addEventListener('click', guardarTarea);
            document.getElementById('cancelar-tarea').addEventListener('click', cancelarTarea);
            
            document.getElementById('abrir-modal-examen').addEventListener('click', () => {
                examenEditando = null;
                document.getElementById('modal-examen-title').textContent = 'Nuevo Examen';
                document.getElementById('examen-status-group').style.display = 'none';
                abrirModal('modal-examen');
            });
            
            document.getElementById('cerrar-modal-examen').addEventListener('click', () => cerrarModal('modal-examen'));
            document.getElementById('guardar-examen').addEventListener('click', guardarExamen);
            
            // Solicitar permisos para notificaciones
            if ('Notification' in window) {
                Notification.requestPermission();
            }
        }

        function toggleSidebar() {
            sidebar.classList.toggle('active');
        }

        function abrirModal(id) {
            // Limpiar errores
            document.querySelectorAll(`#${id} .error-message`).forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll(`#${id} .form-control`).forEach(el => {
                el.classList.remove('error');
            });
            
            document.getElementById(id).classList.add('active');
        }

        function cerrarModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function mostrarError(campoId, mensajeId) {
            document.getElementById(campoId).classList.add('error');
            document.getElementById(mensajeId).style.display = 'block';
            
            // Animación de vibración
            document.getElementById(campoId).style.animation = 'none';
            void document.getElementById(campoId).offsetWidth; // Trigger reflow
            document.getElementById(campoId).style.animation = 'vibrate 0.5s';
        }

        function validarFormulario(modalId) {
            let valido = true;
            const modal = document.getElementById(modalId);
            
            // Validar campos obligatorios
            modal.querySelectorAll('[required]').forEach(input => {
                if (!input.value.trim()) {
                    const errorId = `error-${input.id}`;
                    mostrarError(input.id, errorId);
                    valido = false;
                }
            });
            
            return valido;
        }

        function guardarMateria() {
            if (!validarFormulario('modal-materia')) return;
            
            const nombreMateria = document.getElementById('nombre-materia').value.trim();
            const zonaMateria = parseInt(document.getElementById('zona-materia').value) || 0;

            if (materias.some(m => m.nombre === nombreMateria)) {
                mostrarError('nombre-materia', 'error-nombre-materia');
                document.getElementById('error-nombre-materia').textContent = 'Esta materia ya existe';
                document.getElementById('error-nombre-materia').style.display = 'block';
                return;
            }

            const nuevaMateria = {
                id: Date.now().toString(),
                nombre: nombreMateria,
                zona: zonaMateria
            };
            
            materias.push(nuevaMateria);
            guardarDatos();
            renderizarMaterias();
            
            // Limpiar formulario
            document.getElementById('nombre-materia').value = '';
            document.getElementById('zona-materia').value = '';
            
            cerrarModal('modal-materia');
            mostrarNotificacion(`Materia "${nombreMateria}" agregada`);
        }

        function eliminarMateria(id) {
            if (confirm('¿Eliminar esta materia y todas sus tareas y exámenes asociados?')) {
                // Eliminar tareas y exámenes asociados
                const nombreMateria = materias.find(m => m.id === id)?.nombre;
                if (nombreMateria) {
                    tareas = tareas.filter(t => t.materia !== nombreMateria);
                    examenes = examenes.filter(e => e.materia !== nombreMateria);
                }
                
                // Eliminar la materia
                materias = materias.filter(m => m.id !== id);
                
                // Si la materia eliminada era la seleccionada, limpiar la selección
                if (materiaSeleccionada && materiaSeleccionada.id === id) {
                    materiaSeleccionada = null;
                    tituloTareas.textContent = 'Tareas Pendientes';
                    btnNuevaTarea.style.display = 'none';
                    btnNuevoExamen.style.display = 'none';
                    tareasPendientesContainer.style.display = 'none';
                    examenesPendientesContainer.style.display = 'none';
                    tareasCompletadasContainer.style.display = 'none';
                    examenesCompletadosContainer.style.display = 'none';
                }
                
                guardarDatos();
                renderizarMaterias();
                
                mostrarNotificacion('Materia eliminada');
            }
        }

        function seleccionarMateria(materia) {
            materiaSeleccionada = materia;
            
            // Actualizar UI
            document.querySelectorAll('.materia-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id == materia.id) {
                    item.classList.add('active');
                }
            });
            
            // Mostrar contenido de la materia seleccionada
            tituloTareas.textContent = `Tareas de ${materia.nombre}`;
            btnNuevaTarea.style.display = 'block';
            btnNuevoExamen.style.display = 'block';

            renderizarTareasPendientes();
            renderizarExamenesPendientes();
            renderizarTareasCompletadas();
            renderizarExamenesCompletados();

            if (window.innerWidth <= 768) {
                toggleSidebar(); // Corregido mayúscula
            }
        }

        function renderizarMaterias() {
            materiasList.innerHTML = '';
            
            if (materias.length === 0) {
                materiasList.innerHTML = '<p>No hay materias registradas</p>';
                return;
            }
            
            materias.forEach(materia => {
                const materiaElement = document.createElement('div');
                materiaElement.className = 'materia-item';
                materiaElement.dataset.id = materia.id;
                
                const materiaContent = document.createElement('div');
                materiaContent.innerHTML = `
                    <div>${materia.nombre}</div>
                    <div class="materia-info">
                        Entregados: ${tareas
                            .filter(t => t.materia === materia.nombre && t.completada && t.entregada)
                            .reduce((sum, t) => sum + t.puntos, 0)}/${materia.zona}
                    </div>
                `;
                
                const materiaActions = document.createElement('div');
                materiaActions.className = 'materia-actions';
                materiaActions.innerHTML = `
                    <button class="materia-btn eliminar" onclick="app.eliminarMateria('${materia.id}')">×</button>
                `;
                
                materiaElement.appendChild(materiaContent);
                materiaElement.appendChild(materiaActions);
                
                materiaElement.addEventListener('click', (e) => {
                    // Evitar que el clic en los botones de acción active la selección
                    if (!e.target.closest('.materia-actions')) {
                        seleccionarMateria(materia);
                    }
                });
                
                materiasList.appendChild(materiaElement);
            });
        }

        function renderizarTareasPendientes() {
            listaTareasPendientes.innerHTML = '';
            
            if (!materiaSeleccionada) {
                tareasPendientesContainer.style.display = 'none';
                return;
            }
            
            const tareasMateria = tareas.filter(t => 
                t.materia === materiaSeleccionada.nombre && !t.completada
            );
            
            if (tareasMateria.length === 0) {
                tareasPendientesContainer.style.display = 'none';
                return;
            }
            
            tareasPendientesContainer.style.display = 'block';
            
            tareasMateria.forEach(tarea => {
                const tareaItem = document.createElement('div');
                tareaItem.className = 'tarea-item';
                
                tareaItem.innerHTML = `
                    <div class="tarea-info">
                        <div class="tarea-title">
                            <span class="tarea-prioridad ${tarea.prioridad === 'alta' ? 'prioridad-alta' : 'prioridad-normal'}"></span>
                            ${tarea.descripcion}
                            <span class="tarea-puntos">${tarea.puntos} pts</span>
                        </div>
                        <div class="tarea-descripcion">${tarea.materia}</div>
                        <div class="tarea-fecha">Entrega: ${tarea.fechaEntrega}</div>
                    </div>
                    <div class="tarea-actions">
                        <button class="tarea-btn completar" data-id="${tarea.id}">✓</button>
                        <button class="tarea-btn editar" data-id="${tarea.id}">✏️</button>
                        <button class="tarea-btn eliminar" data-id="${tarea.id}">×</button>
                    </div>
                `;
                
                // Agregar eventos a los botones
                tareaItem.querySelector('.tarea-btn.completar').addEventListener('click', () => completarTarea(tarea.id, true));
                tareaItem.querySelector('.tarea-btn.editar').addEventListener('click', () => editarTarea(tarea.id));
                tareaItem.querySelector('.tarea-btn.eliminar').addEventListener('click', () => eliminarTarea(tarea.id));
                
                listaTareasPendientes.appendChild(tareaItem);
            });
        }

        function renderizarExamenesPendientes() {
            listaExamenesPendientes.innerHTML = '';
            
            if (!materiaSeleccionada) {
                examenesPendientesContainer.style.display = 'none';
                return;
            }
            
            const examenesMateria = examenes.filter(e => 
                e.materia === materiaSeleccionada.nombre && !e.completado
            );
            
            if (examenesMateria.length === 0) {
                examenesPendientesContainer.style.display = 'none';
                return;
            }
            
            examenesPendientesContainer.style.display = 'block';
            
            examenesMateria.forEach(examen => {
                const examenItem = document.createElement('div');
                examenItem.className = 'tarea-item';
                
                examenItem.innerHTML = `
                    <div class="tarea-info">
                        <div class="tarea-title">
                            <span class="tarea-prioridad prioridad-alta"></span>
                            ${examen.descripcion}
                            <span class="tarea-puntos">${examen.puntos} pts</span>
                        </div>
                        <div class="tarea-descripcion">${examen.materia}</div>
                        <div class="tarea-fecha">Fecha: ${examen.fecha}</div>
                        ${examen.utiles ? `<div class="tarea-descripcion">Útiles: ${examen.utiles}</div>` : ''}
                    </div>
                    <div class="tarea-actions">
                        <button class="tarea-btn completar" data-id="${examen.id}">✓</button>
                        <button class="tarea-btn editar" data-id="${examen.id}">✏️</button>
                        <button class="tarea-btn eliminar" data-id="${examen.id}">×</button>
                    </div>
                `;
                
                // Agregar eventos a los botones
                examenItem.querySelector('.tarea-btn.completar').addEventListener('click', () => completarExamen(examen.id, true));
                examenItem.querySelector('.tarea-btn.editar').addEventListener('click', () => editarExamen(examen.id));
                examenItem.querySelector('.tarea-btn.eliminar').addEventListener('click', () => eliminarExamen(examen.id));
                
                listaExamenesPendientes.appendChild(examenItem);
            });
        }

        function renderizarTareasCompletadas() {
            listaTareasCompletadas.innerHTML = '';
            
            if (!materiaSeleccionada) {
                tareasCompletadasContainer.style.display = 'none';
                return;
            }
            
            const tareasCompletadas = tareas.filter(t => 
                t.materia === materiaSeleccionada.nombre && t.completada
            );
            
            if (tareasCompletadas.length === 0) {
                tareasCompletadasContainer.style.display = 'none';
                return;
            }
            
            tareasCompletadasContainer.style.display = 'block';
            
            tareasCompletadas.forEach(tarea => {
                const tareaItem = document.createElement('div');
                tareaItem.className = `tarea-completada ${tarea.entregada ? 'entregada' : 'no-entregada'}`;
                
                tareaItem.innerHTML = `
                    <div class="tarea-completada-info">
                        <div>${tarea.descripcion}</div>
                        <div class="tarea-fecha">Entrega: ${tarea.fechaEntrega}</div>
                    </div>
                    <div>
                        <span class="tarea-completada-status ${tarea.entregada ? 'entregada-text' : 'no-entregada-text'}">
                            ${tarea.entregada ? 'Entregada' : 'No entregada'}
                        </span>
                        <span class="tarea-puntos">${tarea.puntos} pts</span>
                        <button class="tarea-btn eliminar" data-id="${tarea.id}" style="margin-left: 10px;">×</button>
                    </div>
                `;
                
                // Agregar evento al botón de eliminar
                tareaItem.querySelector('.tarea-btn.eliminar').addEventListener('click', () => eliminarTarea(tarea.id));
                
                listaTareasCompletadas.appendChild(tareaItem);
            });
        }

        function renderizarExamenesCompletados() {
            listaExamenesCompletados.innerHTML = '';
            
            if (!materiaSeleccionada) {
                examenesCompletadosContainer.style.display = 'none';
                return;
            }
            
            const examenesCompletados = examenes.filter(e => 
                e.materia === materiaSeleccionada.nombre && e.completado
            );
            
            if (examenesCompletados.length === 0) {
                examenesCompletadosContainer.style.display = 'none';
                return;
            }
            
            examenesCompletadosContainer.style.display = 'block';
            
            examenesCompletados.forEach(examen => {
                const examenItem = document.createElement('div');
                examenItem.className = `tarea-completada ${examen.realizado ? 'entregada' : 'no-entregada'}`;
                
                examenItem.innerHTML = `
                    <div class="tarea-completada-info">
                        <div>${examen.descripcion}</div>
                        <div class="tarea-fecha">Fecha: ${examen.fecha}</div>
                    </div>
                    <div>
                        <span class="tarea-completada-status ${examen.realizado ? 'entregada-text' : 'no-entregada-text'}">
                            ${examen.realizado ? 'Realizado' : 'No realizado'}
                        </span>
                        <span class="tarea-puntos">${examen.puntos} pts</span>
                        <button class="tarea-btn eliminar" data-id="${examen.id}" style="margin-left: 10px;">×</button>
                    </div>
                `;
                
                // Agregar evento al botón de eliminar
                examenItem.querySelector('.tarea-btn.eliminar').addEventListener('click', () => eliminarExamen(examen.id));
                
                listaExamenesCompletados.appendChild(examenItem);
            });
        }

        function editarTarea(id) {
            tareaEditando = tareas.find(t => t.id === id);
            if (!tareaEditando) return;
            
            document.getElementById('modal-tarea-title').textContent = 'Editar Tarea';
            document.getElementById('tarea-descripcion').value = tareaEditando.descripcion;
            document.getElementById('tarea-puntos').value = tareaEditando.puntos;
            document.getElementById('tarea-fecha').value = tareaEditando.fechaEntrega;
            document.getElementById('tarea-prioridad').checked = tareaEditando.prioridad === 'alta';
            
            document.getElementById('tarea-status-group').style.display = 'block';
            document.querySelector(`input[name="tarea-status"][value="${tareaEditando.entregada ? 'entregada' : 'no-entregada'}"]`).checked = true;
            
            document.getElementById('cancelar-tarea').style.display = 'block';
            abrirModal('modal-tarea');
        }

        function guardarTarea() {
            if (!validarFormulario('modal-tarea')) return;
            
            const descripcion = document.getElementById('tarea-descripcion').value.trim();
            const puntos = parseInt(document.getElementById('tarea-puntos').value) || 0;
            const fechaEntrega = document.getElementById('tarea-fecha').value;
            const prioridad = document.getElementById('tarea-prioridad').checked ? 'alta' : 'normal';
            const entregada = tareaEditando ? 
                document.querySelector('input[name="tarea-status"]:checked').value === 'entregada' : true;

            if (tareaEditando) {
                // Editar tarea existente
                tareaEditando.descripcion = descripcion;
                tareaEditando.puntos = puntos;
                tareaEditando.fechaEntrega = fechaEntrega;
                tareaEditando.prioridad = prioridad;
                tareaEditando.entregada = entregada;
                
                mostrarNotificacion('Tarea actualizada');
            } else {
                // Nueva tarea
                const nuevaTarea = {
                    id: Date.now().toString(),
                    materia: materiaSeleccionada.nombre,
                    descripcion,
                    puntos,
                    fechaEntrega,
                    prioridad,
                    completada: false,
                    entregada: true,
                    tipo: 'tarea'
                };
                tareas.push(nuevaTarea);
                
                mostrarNotificacion('Tarea agregada');
                
                // Programar recordatorios
                programarRecordatoriosTarea(nuevaTarea);
            }
            
            guardarDatos();
            renderizarTareasPendientes();
            renderizarTareasCompletadas();
            renderizarMaterias();
            cerrarModal('modal-tarea');
        }

        function programarRecordatoriosTarea(tarea) {
            const fechaEntrega = new Date(tarea.fechaEntrega);
            const hoy = new Date();
            
            // Diferencia en días
            const diffTime = fechaEntrega - hoy;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Programar notificaciones según prioridad
            if (tarea.prioridad === 'alta') {
                // Recordatorio 3, 2 y 1 día antes
                for (let i = 3; i >= 1; i--) {
                    if (diffDays >= i) {
                        const notificacionFecha = new Date(fechaEntrega);
                        notificacionFecha.setDate(notificacionFecha.getDate() - i);
                        
                        // En una implementación real usarías el API de notificaciones push
                        console.log(`Recordatorio programado para ${notificacionFecha.toISOString()}: Tarea de alta prioridad "${tarea.descripcion}"`);
                    }
                }
            } else {
                // Recordatorio 1 día antes
                if (diffDays >= 1) {
                    const notificacionFecha = new Date(fechaEntrega);
                    notificacionFecha.setDate(notificacionFecha.getDate() - 1);
                    
                    console.log(`Recordatorio programado para ${notificacionFecha.toISOString()}: Tarea "${tarea.descripcion}"`);
                }
            }
        }

        function cancelarTarea() {
            if (tareaEditando && confirm('¿Cancelar esta tarea?')) {
                tareaEditando.completada = true;
                tareaEditando.entregada = false;
                
                guardarDatos();
                renderizarTareasPendientes();
                renderizarTareasCompletadas();
                renderizarMaterias();
                cerrarModal('modal-tarea');
                
                mostrarNotificacion('Tarea cancelada');
            }
        }

        function completarTarea(id, entregada) {
            const tarea = tareas.find(t => t.id === id);
            if (!tarea) return;
            
            tarea.completada = true;
            tarea.entregada = entregada;
            
            if (entregada) {
                mostrarNotificacion(`Tarea entregada: +${tarea.puntos} puntos`);
            } else {
                mostrarNotificacion('Tarea marcada como no entregada');
            }
            
            guardarDatos();
            
            // Animación de desaparición
            const tareaElement = document.querySelector(`.tarea-item button.completar[data-id="${id}"]`)?.closest('.tarea-item');
            if (tareaElement) {
                tareaElement.classList.add('fade-out');
                
                setTimeout(() => {
                    renderizarTareasPendientes();
                    renderizarTareasCompletadas();
                    renderizarMaterias();
                }, 300);
            } else {
                renderizarTareasPendientes();
                renderizarTareasCompletadas();
                renderizarMaterias();
            }
        }

        function eliminarTarea(id) {
            if (confirm('¿Eliminar esta tarea permanentemente?')) {
                tareas = tareas.filter(t => t.id !== id);
                guardarDatos();
                
                renderizarTareasPendientes();
                renderizarTareasCompletadas();
                renderizarMaterias();
                
                mostrarNotificacion('Tarea eliminada');
            }
        }

        function editarExamen(id) {
            examenEditando = examenes.find(e => e.id === id);
            if (!examenEditando) return;
            
            document.getElementById('modal-examen-title').textContent = 'Editar Examen';
            document.getElementById('examen-descripcion').value = examenEditando.descripcion;
            document.getElementById('examen-puntos').value = examenEditando.puntos;
            document.getElementById('examen-fecha').value = examenEditando.fecha;
            document.getElementById('examen-utiles').value = examenEditando.utiles || '';
            
            document.getElementById('examen-status-group').style.display = 'block';
            document.querySelector(`input[name="examen-status"][value="${examenEditando.realizado ? 'realizado' : 'no-realizado'}"]`).checked = true;
            
            abrirModal('modal-examen');
        }

        function guardarExamen() {
            if (!validarFormulario('modal-examen')) return;
            
            const descripcion = document.getElementById('examen-descripcion').value.trim();
            const puntos = parseInt(document.getElementById('examen-puntos').value) || 0;
            const fecha = document.getElementById('examen-fecha').value;
            const utiles = document.getElementById('examen-utiles').value.trim();
            const realizado = examenEditando ? 
                document.querySelector('input[name="examen-status"]:checked').value === 'realizado' : false;

            if (examenEditando) {
                // Editar examen existente
                examenEditando.descripcion = descripcion;
                examenEditando.puntos = puntos;
                examenEditando.fecha = fecha;
                examenEditando.utiles = utiles;
                examenEditando.realizado = realizado;
                
                mostrarNotificacion('Examen actualizado');
            } else {
                // Nuevo examen
                const nuevoExamen = {
                    id: Date.now().toString(),
                    materia: materiaSeleccionada.nombre,
                    descripcion,
                    puntos,
                    fecha,
                    utiles,
                    completado: false,
                    realizado: false,
                    tipo: 'examen'
                };
                examenes.push(nuevoExamen);
                
                mostrarNotificacion('Examen agregado');
                
                // Programar recordatorios
                programarRecordatoriosExamen(nuevoExamen);
            }
            
            guardarDatos();
            renderizarExamenesPendientes();
            renderizarExamenesCompletados();
            renderizarMaterias();
            cerrarModal('modal-examen');
        }

        function programarRecordatoriosExamen(examen) {
            const fechaExamen = new Date(examen.fecha);
            const hoy = new Date();
            
            // Diferencia en días
            const diffTime = fechaExamen - hoy;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Recordatorio 2 días antes
            if (diffDays >= 2) {
                const notificacionFecha = new Date(fechaExamen);
                notificacionFecha.setDate(notificacionFecha.getDate() - 2);
                
                // En una implementación real usarías el API de notificaciones push
                console.log(`Recordatorio programado para ${notificacionFecha.toISOString()}: Examen "${examen.descripcion}" - Útiles: ${examen.utiles || 'Ninguno'}`);
            }
        }

        function completarExamen(id, realizado) {
            const examen = examenes.find(e => e.id === id);
            if (!examen) return;
            
            examen.completado = true;
            examen.realizado = realizado;
            
            if (realizado) {
                mostrarNotificacion(`Examen realizado: +${examen.puntos} puntos`);
            } else {
                mostrarNotificacion('Examen marcado como no realizado');
            }
            
            guardarDatos();
            
            // Animación de desaparición
            const examenElement = document.querySelector(`.tarea-item button.completar[data-id="${id}"]`)?.closest('.tarea-item');
            if (examenElement) {
                examenElement.classList.add('fade-out');
                
                setTimeout(() => {
                    renderizarExamenesPendientes();
                    renderizarExamenesCompletados();
                    renderizarMaterias();
                }, 300);
            } else {
                renderizarExamenesPendientes();
                renderizarExamenesCompletados();
                renderizarMaterias();
            }
        }

        function eliminarExamen(id) {
            if (confirm('¿Eliminar este examen permanentemente?')) {
                examenes = examenes.filter(e => e.id !== id);
                guardarDatos();
                
                renderizarExamenesPendientes();
                renderizarExamenesCompletados();
                renderizarMaterias();
                
                mostrarNotificacion('Examen eliminado');
            }
        }

        function mostrarNotificacion(mensaje) {
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion';
            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.classList.add('fade-out');
                setTimeout(() => notificacion.remove(), 300);
            }, 3000);
        }

        // Objeto global para acceder a las funciones desde HTML
        window.app = {
            eliminarMateria,
            completarTarea,
            editarTarea,
            eliminarTarea,
            completarExamen,
            editarExamen,
            eliminarExamen
        };
    </script>
</body>
</html>